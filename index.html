<!doctype html>
<!-- =========================================================
Repo: elizcurley/ProgramGenerator
File: /index.html
Program Evaluation Generator — single-file, offline, no deps
========================================================= -->
<html lang="en">
<head>
<meta charset="utf-8">
<title>Program Evaluation Generator</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
  :root{
    --bg:#f5f7fb;--bg-2:#ebf2ff;--card:#ffffff;--ink:#0f172a;--muted:#6b7280;--line:#e5e7eb;--accent:#2563eb;
    --ok:#0a7f3f;--warn:#c2410c;--shadow:0 2px 8px rgba(0,0,0,.06),0 12px 40px rgba(0,0,0,.12)
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial,sans-serif;color:var(--ink);background:radial-gradient(circle at 20% 20%,#f1f5ff 0,#f5f7fb 35%,#f5f7fb 70%,#edf2ff 100%);line-height:1.6}

  /* ===== Header: compact + sticky that shrinks on scroll ===== */
  header{
    position:sticky;top:0;background:rgba(255,255,255,.96);backdrop-filter:blur(6px);
    border-bottom:1px solid var(--line);box-shadow:0 6px 30px rgba(37,99,235,.08);z-index:10;
  }
  .wrap{max-width:1200px;margin:0 auto;padding:18px 16px}
  .titlebar{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}

  /* CHANGES: smaller default header */
  .hero{display:flex;flex-direction:column;gap:4px;min-width:220px}
  .eyebrow{font-size:12px;font-weight:700;letter-spacing:.12em;color:var(--accent);text-transform:uppercase}
  .title{font-size:20px;font-weight:800;display:flex;align-items:center;gap:8px}
  .subtitle{display:none}            /* hide in header; same text is in details drawer */
  .meta{display:none}                /* hide pills row in header for compactness */
  .banner-row{display:none}          /* keep banners in details drawer only */

  /* Toolbar + buttons */
  .toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:flex-end;min-width:280px}
  button{border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 10px;font:inherit;cursor:pointer;box-shadow:0 1px 0 rgba(0,0,0,.02)}
  button:hover{border-color:#cbd5e1}
  button.primary{background:var(--accent);border-color:var(--accent);color:#fff}
  button.ghost{background:#f8fafc}

  /* Status chip */
  .status{font-size:12px;border:1px solid var(--line);padding:4px 10px;border-radius:999px;background:#fafafa;white-space:nowrap}
  .status.locked{border-color:#cce9d8;background:#f0fdf4;color:var(--ok)}
  .status.unlocked{border-color:#ffe2c7;background:#fff7ed;color:var(--warn)}

  /* CHANGES: prevent overlap — chip drops to its own line on small widths */
  .toolbar .status{order:2;flex-basis:100%;text-align:right}
  @media(min-width:700px){ .toolbar .status{order:0;flex-basis:auto;margin-left:4px} }

  /* CHANGES: header “compact on scroll” size */
  header.compact .wrap{padding:10px 12px}
  header.compact .title{font-size:18px}
  header.compact .eyebrow{display:none}

  /* Layout/cards */
  .layout{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px}
  @media(max-width:1024px){.layout{grid-template-columns:1fr}}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;box-shadow:var(--shadow);position:relative;overflow:hidden}
  .card h2{margin:0;padding:16px;border-bottom:1px solid var(--line);font-size:18px}
  .card .body{padding:16px}
  .card::before{content:"";position:absolute;inset:0;background:linear-gradient(120deg,rgba(37,99,235,.06),rgba(37,99,235,.00),rgba(14,165,233,.04));opacity:.6;pointer-events:none}

  .pill{display:inline-flex;align-items:center;gap:6px;font-size:13px;font-weight:700;padding:6px 10px;border-radius:999px;border:1px solid #cbd5e1;background:#f8fafc;color:#0f172a;box-shadow:0 1px 3px rgba(15,23,42,.08)}
  .pill.accent{background:#e0e7ff;border-color:#c7d2fe;color:#1e3a8a}
  .pill.soft{background:#ecfdf3;border-color:#bbf7d0;color:#166534}
  .pill.outline{background:transparent}

  .banner{background:#f8fafc;border:1px dashed #cbd5e1;border-radius:12px;padding:10px 12px;color:#334155;font-size:13px}
  .banner.primary{border-color:#bfdbfe;background:#e0f2fe;color:#0f172a}
  .banner.warn{border-color:#fed7aa;background:#fff7ed;color:#7c2d12}
  .banner.neutral{border-color:#e5e7eb;background:#f8fafc}

  .grid{display:grid;grid-template-columns:240px 1fr;border:1px solid var(--line);border-radius:12px;overflow:hidden}
  .row{display:contents}
  .key{padding:10px 12px;background:#f8fafc;border-bottom:1px solid var(--line);border-right:1px solid var(--line);font-weight:600}
  .val{padding:10px 12px;border-bottom:1px solid var(--line);white-space:pre-wrap}
  .val p{margin:0 0 10px}
  h3{margin:16px 0 8px}
  textarea{width:100%;border:1px solid var(--line);border-radius:10px;padding:10px 12px;background:#fff;font:inherit;min-height:120px;resize:vertical}
  .sidecol{display:flex;flex-direction:column;gap:16px}
  .hr{height:1px;background:var(--line);margin:12px 0}
  .toast{position:fixed;bottom:12px;right:12px;background:#111;color:#fff;padding:10px 12px;border-radius:10px;opacity:0;transform:translateY(8px);transition:.2s;pointer-events:none}
  .toast.show{opacity:1;transform:translateY(0)}

  @media(max-width:900px){
    .titlebar{padding-right:16px}
    .toolbar{justify-content:flex-start}
  }

  @media print{
    header,.toast,.toolbar{display:none !important}
    body{background:#fff}
    .card{box-shadow:none;border-color:#ddd}
    .layout{grid-template-columns:1fr}
  }
</style>
</head>
<body>
<header id="siteHeader">
  <div class="wrap titlebar">
    <div class="hero">
      <div class="eyebrow">Program Evaluation Assignment</div>
      <div class="title">Program Evaluation Generator <span class="pill accent">Program Evaluation</span></div>
      <!-- subtitle/meta hidden in header; they appear in the details drawer -->
      <p class="subtitle">Use this generator to craft your plan for the Program Evaluation assignment in SOW5404. If you need the Program Development assignment, open the companion site instead so the prompts match.</p>
      <div class="meta">
        <span class="pill soft">Course: <span id="courseTag">SOW5404 • Spring 2026</span></span>
        <span class="pill outline">Single-file • Offline-ready</span>
        <span class="pill outline">Built-in Word export</span>
      </div>
      <div class="banner-row">
        <div class="banner primary">Editing is enabled only when <strong>Locked</strong>. While locked, a draft autosaves to your browser every few seconds. <em>Always</em> click <strong>Save</strong> before leaving the page.</div>
        <div class="banner neutral">This page is dedicated to the <strong>PROGRAM EVALUATION</strong> assignment. Use the <em>Program Development Generator</em> for the separate development project.</div>
        <div class="banner warn" role="status">Note: When opening an exported Word file you may see an "unreadable content" warning. Click <strong>Yes</strong> to recover and the document will load correctly.</div>
      </div>
    </div>
    <div class="toolbar">
      <button id="btnRandom" title="Randomize scenario (Alt+R)">Randomize</button>
      <button id="btnLock" class="primary" title="Lock or Unlock for writing (Alt+L)">Lock</button>
      <button id="btnNew" class="ghost" title="Clear plan fields">New</button>
      <button id="btnSave" title="Save draft (Ctrl+S / Cmd+S)">Save</button>
      <button id="btnLoad" title="Load saved draft">Load</button>
      <button id="btnCopyScenario" title="Copy scenario details as plain text">Copy Scenario</button>
      <button id="btnCopyAll" title="Copy scenario + plan as plain text">Copy All</button>
      <button id="btnExport" title="Export to Word (.docx) (Alt+E)">Export Word</button>
      <button id="btnPrint" title="Print (Alt+P)">Print</button>
      <span id="statusChip" class="status unlocked">Unlocked</span>
    </div>
  </div>
</header>

<!-- Keep all rich guidance in the drawer so header stays tiny -->
<div class="wrap info-drawer" id="assignmentNotes">
  <details>
    <summary>Assignment details &amp; warnings</summary>
    <p class="subtitle">Use this generator to craft your plan for the Program Evaluation assignment in SOW5404. If you need the Program Development assignment, open the companion site instead so the prompts match.</p>
    <div class="banner-row">
      <div class="banner primary">Editing is enabled only when <strong>Locked</strong>. While locked, a draft autosaves to your browser every few seconds. <em>Always</em> click <strong>Save</strong> before leaving the page.</div>
      <div class="banner neutral">This page is dedicated to the <strong>PROGRAM EVALUATION</strong> assignment. Use the <em>Program Development Generator</em> for the separate development project.</div>
      <div class="banner warn" role="status">Note: When opening an exported Word file you may see an "unreadable content" warning. Click <strong>Yes</strong> to recover and the document will load correctly.</div>
    </div>
  </details>
</div>

<main class="wrap">
  <div class="layout">
    <!-- LEFT: Scenario panel -->
    <div class="sidecol">
      <div class="card">
        <h2>Scenario Panel</h2>
        <div class="body">
          <h3 id="scenarioTitle">No scenario selected</h3>
          <div id="scenarioGrid" class="grid" aria-live="polite"></div>
        </div>
      </div>
    </div>

    <!-- RIGHT: Evaluation Builder -->
    <div class="sidecol">
      <div class="card" id="builderCard">
        <h2>Evaluation Builder</h2>
        <div class="body">
          <div style="display:grid;gap:12px">
            <div><label>Scenario Context & Stakeholders</label><textarea id="f_context" disabled></textarea></div>
            <div><label>Your Program or Practice Design</label><textarea id="f_design" disabled></textarea></div>
            <div><label>Evaluation Purpose & Questions</label><textarea id="f_purpose" disabled></textarea></div>
            <div><label>Outcomes (Conceptualization)</label><textarea id="f_outcomes" disabled></textarea></div>
            <div><label>Operationalization & Data Sources</label><textarea id="f_operational" disabled></textarea></div>
            <div><label>Evaluation Design Plan</label><textarea id="f_designplan" disabled></textarea></div>
            <div><label>Ethics, Power, Limitations & Communication</label><textarea id="f_ethics" disabled></textarea></div>
            <div><label>Assumptions (optional)</label><textarea id="f_assumptions" disabled></textarea></div>
          </div>
        </div>
      </div>
    </div>
    <!-- /RIGHT -->
  </div>
</main>

<div id="toast" class="toast" role="status" aria-live="polite" aria-atomic="true"></div>

<script>
/* ======================== CONFIG ======================== */
const CONFIG={ COURSE_TAG:'SOW5404 • Spring 2026', APPKEY_PREFIX:'PE_APP_APPKEY_', DEFAULT_EXPORT_NAME:'Program_Evaluation.docx' };

/* ==================== DATA — SCENARIOS ================== */
const SCENARIOS=[
  /* ... keep full scenarios as in your source ... */
  {title:"Jefferson Middle School: Discipline, Trust, and a System in Strain", /* content omitted for brevity here */ setting_snapshot:`Jefferson Middle School serves approximately 700 students in a neighborhood undergoing rapid gentrification. ...`, population_snapshot:`...`, core_problems:`...`, stakeholder_glimpses:`...`, equity_signals:`...`, constraints_resources:`...`, role:`...`},
  /* ... rest unchanged ... */
];

/* =============== HELPERS =============== */
function $(id){return document.getElementById(id)}
function escapeHTML(s=''){return s.replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]))}
function normalizeDashes(s=''){return s.replace(/[\u2013\u2014]/g,'-')}
function stripEmojis(s=''){return s.replace(/[\p{Extended_Pictographic}\uFE0F]/gu,'')}
function paragraphsHTML(text=''){
  let t=text.replace(/\r\n/g,'\n'); t=normalizeDashes(t); t=stripEmojis(t);
  return t.split(/\n\s*\n/g).map(p=>`<p>${escapeHTML(p).replace(/\n/g,'<br>')}</p>`).join('')
}
function toast(msg){const el=$('toast');el.textContent=msg;el.classList.add('show');setTimeout(()=>el.classList.remove('show'),1200)}
function nowISO(){return new Date().toISOString()}
function activeIsTyping(){const ae=document.activeElement; if(!ae) return false; const tag=ae.tagName.toLowerCase(); return tag==='textarea'||tag==='input'||ae.isContentEditable}

/* clipboard fallback */
async function copyTextSafe(txt){
  try{
    if(navigator.clipboard && window.isSecureContext!==false){
      await navigator.clipboard.writeText(txt);
      return true;
    }
  }catch(_){}
  const ta=document.createElement('textarea');
  ta.value=txt; ta.style.position='fixed'; ta.style.opacity='0';
  document.body.appendChild(ta); ta.focus(); ta.select();
  let ok=false; try{ ok=document.execCommand('copy'); }catch(_){}
  ta.remove(); return ok;
}

/* simple hash */
function hashString(s){ let h=5381; for(let i=0;i<s.length;i++){ h=((h<<5)+h) ^ s.charCodeAt(i); } return (h>>>0).toString(36); }

/* =============== STATE =============== */
let locked=false, currentScenario=null, autosaveTimer=null, lastSavedHash='';

/* =============== INIT =============== */
document.addEventListener('DOMContentLoaded',()=>{
  $('courseTag').textContent=CONFIG.COURSE_TAG;
  bind('btnRandom', onRandomize); bind('btnLock', onLockToggle); bind('btnNew', onNew);
  bind('btnSave', onSave); bind('btnLoad', onLoad);
  bind('btnCopyScenario', onCopyScenario); bind('btnCopyAll', onCopyAll);
  bind('btnExport', onExport); bind('btnPrint', ()=>window.print());

  document.addEventListener('keydown', e=>{
    const modS=(e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='s'; if(modS){e.preventDefault();onSave();return;}
    if(activeIsTyping()) return;
    if(e.altKey&&/r/i.test(e.key)){e.preventDefault();onRandomize();}
    if(e.altKey&&/l/i.test(e.key)){e.preventDefault();onLockToggle();}
    if(e.altKey&&/e/i.test(e.key)){e.preventDefault();onExport();}
    if(e.altKey&&/p/i.test(e.key)){e.preventDefault();window.print();}
  });

  /* CHANGES: shrink header on scroll */
  const hdr=document.getElementById('siteHeader');
  const onScroll=()=>{ if(window.scrollY>8){hdr.classList.add('compact')} else {hdr.classList.remove('compact')} };
  onScroll();
  window.addEventListener('scroll', onScroll, {passive:true});
});

/* Optional: make header non-sticky entirely (uncomment to disable sticky) */
// document.getElementById('siteHeader').style.position = 'static';

function bind(id,fn){const el=$(id); if(el) el.addEventListener('click',fn)}

/* =============== RANDOMIZE / RENDER =============== */
function onRandomize(){
  if(!SCENARIOS||!SCENARIOS.length){toast('No scenarios available');return;}
  const idx=Math.floor(Math.random()*SCENARIOS.length);
  currentScenario=SCENARIOS[idx];
  renderScenario(currentScenario);
  clearBuilder();
  lastSavedHash='';
  toast('Scenario selected');
}
function renderScenario(s){
  $('scenarioTitle').textContent=s?.title||'Untitled';
  const grid=$('scenarioGrid'); grid.innerHTML='';
  const map={
    'Setting Snapshot':s.setting_snapshot,
    'Population Snapshot':s.population_snapshot,
    'Core Problems or Tensions':s.core_problems,
    'Stakeholder Glimpses':s.stakeholder_glimpses,
    'Equity Signals':s.equity_signals,
    'Known Constraints and Resources':s.constraints_resources,
    'Your Role':s.role
  };
  for(const k in map){
    grid.insertAdjacentHTML('beforeend',
      `<div class="row"><div class="key">${escapeHTML(k)}</div><div class="val">${paragraphsHTML(map[k]||'')}</div></div>`
    );
  }
}

/* =============== LOCK / AUTOSAVE =============== */
function setLocked(v){
  locked=v;
  [...document.querySelectorAll('textarea')].forEach(f=>f.disabled=!locked);
  $('btnLock').textContent=locked?'Unlock':'Lock';
  const chip=$('statusChip'); chip.textContent=locked?'Locked for writing':'Unlocked';
  chip.classList.toggle('locked',locked); chip.classList.toggle('unlocked',!locked);
  if(locked){startAutosave()} else {stopAutosave()}
  lastSavedHash='';
}
function onLockToggle(){ if(!currentScenario){toast('Randomize a scenario first');return;} setLocked(!locked) }
function startAutosave(){ stopAutosave(); autosaveTimer=setInterval(onSave,4000) }
function stopAutosave(){ if(autosaveTimer){clearInterval(autosaveTimer); autosaveTimer=null} }

/* =============== BUILDER =============== */
function clearBuilder(){
  ['f_context','f_design','f_purpose','f_outcomes','f_operational','f_designplan','f_ethics','f_assumptions']
    .forEach(id=>$(id).value='');
}

/* =============== SAVE / LOAD =============== */
function storageKey(){const title=(currentScenario?.title||'UNTITLED').slice(0,50); return CONFIG.APPKEY_PREFIX+title}
function collectData(){
  const fields={
    context:$('f_context').value,
    design:$('f_design').value,
    purpose:$('f_purpose').value,
    outcomes:$('f_outcomes').value,
    operational:$('f_operational').value,
    designplan:$('f_designplan').value,
    ethics:$('f_ethics').value,
    assumptions:$('f_assumptions').value
  };
  return {caseTitle:currentScenario?.title||'', fields, timestamp:nowISO()}
}
function onSave(){ if(!currentScenario){toast('Nothing to save');return;}
  try{
    const payload = JSON.stringify(collectData());
    const h = hashString(payload);
    if(h===lastSavedHash){ return; }
    localStorage.setItem(storageKey(), payload);
    lastSavedHash = h;
    toast('Saved');
  }catch(e){console.error(e);toast('Save failed')}
}
function onLoad(){ if(!currentScenario){toast('Randomize a scenario first');return;}
  const raw=localStorage.getItem(storageKey()); if(!raw){toast('No saved draft');return;}
  try{
    const d=JSON.parse(raw);
    $('f_context').value=d.fields?.context||'';
    $('f_design').value=d.fields?.design||'';
    $('f_purpose').value=d.fields?.purpose||'';
    $('f_outcomes').value=d.fields?.outcomes||'';
    $('f_operational').value=d.fields?.operational||'';
    $('f_designplan').value=d.fields?.designplan||'';
    $('f_ethics').value=d.fields?.ethics||'';
    $('f_assumptions').value=d.fields?.assumptions||'';
    toast('Loaded');
    lastSavedHash='';
  }catch(e){console.error(e);toast('Load failed')}
}

/* =============== COPY / EXPORT =============== */
function plainScenarioText(){
  if(!currentScenario) return 'No scenario selected.';
  const s=currentScenario;
  const kv=[
    ['Title',s.title],['Setting Snapshot',s.setting_snapshot],['Population Snapshot',s.population_snapshot],
    ['Core Problems or Tensions',s.core_problems],['Stakeholder Glimpses',s.stakeholder_glimpses],
    ['Equity Signals',s.equity_signals],['Known Constraints and Resources',s.constraints_resources],['Your Role',s.role]
  ];
  return kv.map(([k,v])=>`${k}:\n${normalizeDashes(stripEmojis(v||''))}`).join('\n\n')
}
function plainAllText(){
  const d=collectData();
  return `${plainScenarioText()}

Scenario Context & Stakeholders:
${d.fields.context}

Your Program or Practice Design:
${d.fields.design}

Evaluation Purpose & Questions:
${d.fields.purpose}

Outcomes (Conceptualization):
${d.fields.outcomes}

Operationalization & Data Sources:
${d.fields.operational}

Evaluation Design Plan:
${d.fields.designplan}

Ethics, Power, Limitations & Communication:
${d.fields.ethics}

Assumptions:
${d.fields.assumptions}

Saved: ${d.timestamp}`
}
async function onCopyScenario(){
  const ok = await copyTextSafe(plainScenarioText());
  toast(ok?'Scenario copied':'Copy failed');
}
async function onCopyAll(){
  const ok = await copyTextSafe(plainAllText());
  toast(ok?'All copied':'Copy failed');
}

function onExport(){
  if(!currentScenario){toast('Randomize a scenario first');return;}
  const d=collectData(), s=currentScenario;
  const gridHTML=`<table border="1" cellpadding="6" cellspacing="0" style="border-collapse:collapse;width:100%">
    ${Object.entries({
      'Setting Snapshot':s.setting_snapshot,
      'Population Snapshot':s.population_snapshot,
      'Core Problems or Tensions':s.core_problems,
      'Stakeholder Glimpses':s.stakeholder_glimpses,
      'Equity Signals':s.equity_signals,
      'Known Constraints and Resources':s.constraints_resources,
      'Your Role':s.role
    }).map(([k,v])=>`<tr><td style="width:260px;font-weight:bold;background:#f5f5f5">${escapeHTML(k)}</td><td>${paragraphsHTML(v||'')}</td></tr>`).join('')}
  </table>`;
  const html=`<h1>${escapeHTML(s.title||'Untitled')}</h1>
    <p><strong>${escapeHTML(CONFIG.COURSE_TAG)}</strong></p>
    <h2>Scenario Details</h2>${gridHTML}
    <h2>Scenario Context & Stakeholders</h2><p>${escapeHTML(d.fields.context).replace(/\n/g,'<br>')}</p>
    <h2>Your Program or Practice Design</h2><p>${escapeHTML(d.fields.design).replace(/\n/g,'<br>')}</p>
    <h2>Evaluation Purpose & Questions</h2><p>${escapeHTML(d.fields.purpose).replace(/\n/g,'<br>')}</p>
    <h2>Outcomes (Conceptualization)</h2><p>${escapeHTML(d.fields.outcomes).replace(/\n/g,'<br>')}</p>
    <h2>Operationalization & Data Sources</h2><p>${escapeHTML(d.fields.operational).replace(/\n/g,'<br>')}</p>
    <h2>Evaluation Design Plan</h2><p>${escapeHTML(d.fields.designplan).replace(/\n/g,'<br>')}</p>
    <h2>Ethics, Power, Limitations & Communication</h2><p>${escapeHTML(d.fields.ethics).replace(/\n/g,'<br>')}</p>
    ${d.fields.assumptions?.trim()?`<h2>Assumptions</h2><p>${escapeHTML(d.fields.assumptions).replace(/\n/g,'<br>')}</p>`:''}
    <p><em>Exported: ${escapeHTML(d.timestamp)}</em></p>`;
  window.htmlDocx.asBlobAsync(html).then(function(blob){
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    const safe=(s.title||'Program_Evaluation').replace(/[^\w\-]+/g,'_').slice(0,80)+'.docx';
    a.download=safe||CONFIG.DEFAULT_EXPORT_NAME;
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{URL.revokeObjectURL(a.href);a.remove();},0);
    toast('Exported .docx');
  }).catch(function(err){
    console.error(err); toast('Export failed');
  });
}
function onNew(){clearBuilder(); lastSavedHash=''; toast('Cleared')}
</script>

<!-- ===== DOCX exporter shim (unchanged) ===== -->
<script>
/* all internals wrapped to avoid leaking globals like CRC_TABLE */
(() => {
  function utf8Bytes(str){str=String(str);const b=[];for(let i=0;i<str.length;i++){let c=str.charCodeAt(i);if(c>=0xD800&&c<=0xDBFF&&i+1<str.length){const c2=str.charCodeAt(++i);if((c2&0xFC00)===0xDC00){c=0x10000+((c-0xD800)<<10)+(c2-0xDC00)}else{i--}}if(c<=0x7F)b.push(c);else if(c<=0x7FF)b.push(0xC0|(c>>6),0x80|(c&0x3F));else if(c<=0xFFFF)b.push(0xE0|(c>>12),0x80|((c>>6)&0x3F),0x80|(c&0x3F));else b.push(0xF0|(c>>18),0x80|((c>>12)&0x3F),0x80|((c>>6)&0x3F),0x80|(c&0x3F))}return new Uint8Array(b)}
  const CRC_TABLE=(()=>{let c,t=[];for(let n=0;n<256;n++){c=n;for(let k=0;k<8;k++){c=((c&1)?(0xEDB88320^(c>>>1)):(c>>>1))}t[n]=c>>>0}return t})();
  function crc32(u8){let c=0^(-1);for(let i=0;i<u8.length;i++){c=(c>>>8)^CRC_TABLE[(c^u8[i])&255]}return (c^(-1))>>>0}
  function le16(n){return new Uint8Array([n&255,(n>>8)&255])}
  function le32(n){return new Uint8Array([n&255,(n>>8)&255,(n>>16)&255,(n>>24)&255])}
  function cat(chunks){const L=chunks.reduce((a,b)=>a+b.length,0);const out=new Uint8Array(L);let o=0;for(const c of chunks){out.set(c,o);o+=c.length}return out}
  function zipBlobSync(files,mime){const LFH=0x04034b50,CDH=0x02014b50,EOCD=0x06054b50,ver=20,gpbf=0x0800,method=0;const now=new Date();const dosTime=((now.getHours()<<11)|(now.getMinutes()<<5)|(Math.floor(now.getSeconds()/2)));const dosDate=(((now.getFullYear()-1980)<<9)|((now.getMonth()+1)<<5)|now.getDate());const lfhChunks=[];const centrals=[];let offset=0;const headers=[];for(const f of files){const name=utf8Bytes(f.name);const data=f.data;const sum=crc32(data);const lfh=cat([le32(LFH),le16(ver),le16(gpbf),le16(method),le16(dosTime),le16(dosDate),le32(sum),le32(data.length),le32(data.length),le16(name.length),le16(0),name,data]);lfhChunks.push(lfh);headers.push({name,sum,size:data.length,offset,dosTime,dosDate});offset+=lfh.length}const startCD=offset;for(const h of headers){const cdh=cat([le32(CDH),le16(0x033F),le16(0x003F),le16(gpbf),le16(method),le16(h.dosTime),le16(h.dosDate),le32(h.sum),le32(h.size),le32(h.size),le16(h.name.length),le16(0),le16(0),le16(0),le16(0),le32(0),le32(h.offset),h.name]);centrals.push(cdh);offset+=cdh.length}const centralDir=cat(centrals);const end=cat([le32(EOCD),le16(0),le16(0),le16(headers.length),le16(headers.length),le32(centralDir.length),le32(startCD),le16(0)]);const zip=cat([...lfhChunks,centralDir,end]);return new Blob([zip],{type:mime||'application/zip'})}
  function sanitize(text){return String(text||"").replace(/[\u2013\u2014]/g,"-").replace(/[\p{Extended_Pictographic}\uFE0F]/gu,"")}
  function esc(s){return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}
  function runText(t){return `<w:r><w:t xml:space="preserve">${esc(t)}</w:t></w:r>`}
  function p(children,style){return `<w:p>${style?`<w:pPr><w:pStyle w:val="${style}"/></w:pPr>`:""}${children||""}</w:p>`}
  function heading(text,level){const map={1:"Heading1",2:"Heading2",3:"Heading3"};return p(runText(text),map[level]||"Heading2")}
  function paragraphFromHTML(node){
    let out = "";
    node.childNodes.forEach(ch => {
      if (ch.nodeType === 3) { out += runText(ch.nodeValue || ""); }
      else if (ch.nodeName === "BR") { out += '<w:r><w:br/></w:r>'; }
      else if (ch.nodeType === 1) { out += paragraphFromHTML(ch); }
    });
    return out;
  }
  function para(text){return p(runText(text),null)}
  function parseHTMLtoDoc(xmlString){
    const dom=new DOMParser().parseFromString(`<div>${xmlString}</div>`,'text/html');
    const root=dom.body.firstChild||dom.body;
    const blocks=root.querySelectorAll('h1,h2,h3,p,table');
    let bodyParts=[];
    if(blocks.length===0){ bodyParts=[para(sanitize(root.textContent||''))] }
    else {
      blocks.forEach(el=>{
        const tag=el.tagName.toLowerCase();
        if(tag==='h1'){bodyParts.push(heading(el.textContent||'',1))}
        else if(tag==='h2'){bodyParts.push(heading(el.textContent||'',2))}
        else if(tag==='h3'){bodyParts.push(heading(el.textContent||'',3))}
        else if(tag==='p'){bodyParts.push(p(paragraphFromHTML(el),null))}
        else if(tag==='table'){
          const rows=[...el.querySelectorAll('tr')].map(tr=>{
            const cells=[...tr.children].map(td=>{
              const txt=td.textContent||'';
              return `<w:tc><w:tcPr/><w:p><w:r><w:t xml:space="preserve">${esc(txt)}</w:t></w:r></w:p></w:tc>`;
            }).join('');
            return `<w:tr>${cells}</w:tr>`;
          }).join('');
          bodyParts.push(`<w:tbl><w:tblPr/><w:tblGrid/>${rows}</w:tbl>`);
        }
      });
    }
    return bodyParts.join('');
  }
  function buildDocxFromHTML(htmlInput){
    const safe = sanitize(htmlInput);
    const docBody = parseHTMLtoDoc(safe);
    const styles=`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
    <w:styles xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">
      <w:style w:type="paragraph" w:styleId="Heading1"><w:name w:val="heading 1"/><w:basedOn w:val="Normal"/><w:pPr><w:keepNext/><w:keepLines/></w:pPr><w:rPr><w:b/><w:sz w:val="32"/></w:rPr></w:style>
      <w:style w:type="paragraph" w:styleId="Heading2"><w:name w:val="heading 2"/><w:basedOn w:val="Normal"/><w:pPr><w:keepNext/><w:keepLines/></w:pPr><w:rPr><w:b/><w:sz w:val="28"/></w:rPr></w:style>
      <w:style w:type="paragraph" w:styleId="Heading3"><w:name w:val="heading 3"/><w:basedOn w:val="Normal"/><w:pPr><w:keepNext/><w:keepLines/></w:pPr><w:rPr><w:b/><w:sz w:val="24"/></w:rPr></w:style>
    </w:styles>`;
    const contentTypes=`<?xml version="1.0" encoding="UTF-8"?>
    <Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">
      <Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>
      <Default Extension="xml" ContentType="application/xml"/>
      <Override PartName="/word/document.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml"/>
      <Override PartName="/word/styles.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.styles+xml"/>
    </Types>`;
    const rootRels=`<?xml version="1.0" encoding="UTF-8"?>
    <Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
      <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="word/document.xml"/>
    </Relationships>`;
    const docRels=`<?xml version="1.0" encoding="UTF-8"?>
    <Relationships xmlns="http://schemas.openxmlformats.org/officeDocument/2006/relationships">
      <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/styles" Target="styles.xml"/>
    </Relationships>`;
    const documentXML=`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
    <w:document xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">
      <w:body>${docBody}<w:sectPr/></w:body>
    </w:document>`;
    const files=[
      {name:'[Content_Types].xml',data:utf8Bytes(contentTypes)},
      {name:'_rels/.rels',data:utf8Bytes(rootRels)},
      {name:'word/document.xml',data:utf8Bytes(documentXML)},
      {name:'word/_rels/document.xml.rels',data:utf8Bytes(docRels)},
      {name:'word/styles.xml',data:utf8Bytes(styles)}
    ];
    return zipBlobSync(files,'application/vnd.openxmlformats-officedocument.wordprocessingml.document');
  }
  const api=window.htmlDocx||{};
  api.asBlob=function(html){ return buildDocxFromHTML(html); };
  api.asBlobAsync=function(html){ return Promise.resolve(buildDocxFromHTML(html)); };
  window.htmlDocx=api;
})();
</script>

</body>
</html>
