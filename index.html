<!doctype html>
<!-- =========================================================
Repo: elizcurley/ProgramGenerator
File: /index.html
Program Evaluation Generator — single-file, offline, no deps
========================================================= -->
<html lang="en">
<head>
<meta charset="utf-8">
<title>Program Evaluation Generator</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  :root{
    --bg:#f6f7fb;--card:#ffffff;--ink:#13151a;--muted:#6b7280;--line:#e5e7eb;--accent:#2563eb;
    --ok:#0a7f3f;--warn:#c2410c;--shadow:0 2px 8px rgba(0,0,0,.06),0 8px 24px rgba(0,0,0,.06)
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial,sans-serif;color:var(--ink);background:var(--bg);line-height:1.5}
  header{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--line);z-index:10}
  .wrap{max-width:1200px;margin:0 auto;padding:16px}
  .titlebar{display:flex;gap:12px;align-items:center;justify-content:space-between}
  .course{font-size:14px;color:var(--muted)}
  .toolbar{display:flex;flex-wrap:wrap;gap:8px}
  button{border:1px solid var(--line);background:#fff;border-radius:10px;padding:9px 12px;font:inherit;cursor:pointer;box-shadow:0 1px 0 rgba(0,0,0,.02)}
  button:hover{border-color:#cbd5e1}
  button.primary{background:var(--accent);border-color:var(--accent);color:#fff}
  button.ghost{background:#f8fafc}
  .status{font-size:12px;border:1px solid var(--line);padding:4px 10px;border-radius:999px;background:#fafafa}
  .status.locked{border-color:#cce9d8;background:#f0fdf4;color:var(--ok)}
  .status.unlocked{border-color:#ffe2c7;background:#fff7ed;color:var(--warn)}
  .layout{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px}
  @media(max-width:1024px){.layout{grid-template-columns:1fr}}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;box-shadow:var(--shadow)}
  .card h2{margin:0;padding:16px;border-bottom:1px solid var(--line);font-size:18px}
  .card .body{padding:16px}
  .banner{margin-top:8px;background:#f1f5f9;border:1px dashed #cbd5e1;border-radius:10px;padding:8px 12px;color:#334155;font-size:13px}
  .grid{display:grid;grid-template-columns:240px 1fr;border:1px solid var(--line);border-radius:12px;overflow:hidden}
  .row{display:contents}
  .key{padding:10px 12px;background:#f8fafc;border-bottom:1px solid var(--line);border-right:1px solid var(--line);font-weight:600}
  .val{padding:10px 12px;border-bottom:1px solid var(--line);white-space:pre-wrap}
  .val p{margin:0 0 10px}
  h3{margin:16px 0 8px}
  textarea{width:100%;border:1px solid var(--line);border-radius:10px;padding:10px 12px;background:#fff;font:inherit;min-height:120px;resize:vertical}
  .sidecol{display:flex;flex-direction:column;gap:16px}
  .hr{height:1px;background:var(--line);margin:12px 0}
  .toast{position:fixed;bottom:12px;right:12px;background:#111;color:#fff;padding:10px 12px;border-radius:10px;opacity:0;transform:translateY(8px);transition:.2s;pointer-events:none}
  .toast.show{opacity:1;transform:translateY(0)}
  @media print{
    header,.toast,.toolbar{display:none !important}
    body{background:#fff}
    .card{box-shadow:none;border-color:#ddd}
    .layout{grid-template-columns:1fr}
  }
</style>
</head>
<body>
<header>
  <div class="wrap titlebar">
    <div>
      <div style="font-size:20px;font-weight:800">Program Evaluation Generator</div>
      <div class="course" id="courseTag">SOW5404 • Spring 2026</div>
      <div class="banner">Editing is enabled only when <strong>Locked</strong>. While locked, a draft autosaves to your browser every few seconds. <em>Always</em> click <strong>Save</strong> before leaving the page.</div>
      <div class="banner" role="status">Note: When opening an exported Word file you may see an "unreadable content" warning. Click <strong>Yes</strong> to recover and the document will load correctly.</div>
    </div>
    <div class="toolbar">
      <button id="btnRandom" title="Randomize scenario (Alt+R)">Randomize</button>
      <button id="btnLock" class="primary" title="Lock or Unlock for writing (Alt+L)">Lock</button>
      <button id="btnNew" class="ghost" title="Clear plan fields">New</button>
      <button id="btnSave" title="Save draft (Ctrl+S / Cmd+S)">Save</button>
      <button id="btnLoad" title="Load saved draft">Load</button>
      <button id="btnCopyScenario" title="Copy scenario details as plain text">Copy Scenario</button>
      <button id="btnCopyAll" title="Copy scenario + plan as plain text">Copy All</button>
      <button id="btnExport" title="Export to Word (.docx) (Alt+E)">Export Word</button>
      <button id="btnPrint" title="Print (Alt+P)">Print</button>
      <span id="statusChip" class="status unlocked">Unlocked</span>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="layout">
    <!-- LEFT: Scenario panel -->
    <div class="sidecol">
      <div class="card">
        <h2>Scenario Panel</h2>
        <div class="body">
          <h3 id="scenarioTitle">No scenario selected</h3>
          <div id="scenarioGrid" class="grid" aria-live="polite"></div>
        </div>
      </div>
    </div>

    <!-- RIGHT: Evaluation Builder -->
    <div class="sidecol">
      <div class="card" id="builderCard">
        <h2>Evaluation Builder</h2>
        <div class="body">
          <div style="display:grid;gap:12px">
            <div><label>Scenario Context & Stakeholders</label><textarea id="f_context" disabled></textarea></div>
            <div><label>Your Program or Practice Design</label><textarea id="f_design" disabled></textarea></div>
            <div><label>Evaluation Purpose & Questions</label><textarea id="f_purpose" disabled></textarea></div>
            <div><label>Outcomes (Conceptualization)</label><textarea id="f_outcomes" disabled></textarea></div>
            <div><label>Operationalization & Data Sources</label><textarea id="f_operational" disabled></textarea></div>
            <div><label>Evaluation Design Plan</label><textarea id="f_designplan" disabled></textarea></div>
            <div><label>Ethics, Power, Limitations & Communication</label><textarea id="f_ethics" disabled></textarea></div>
            <div><label>Assumptions (optional)</label><textarea id="f_assumptions" disabled></textarea></div>
          </div>
        </div>
      </div>
    </div>
    <!-- /RIGHT -->
  </div>
</main>

<div id="toast" class="toast" role="status" aria-live="polite" aria-atomic="true"></div>


<script>
/* ======================== CONFIG ======================== */
const CONFIG={ COURSE_TAG:'SOW5404 • Spring 2026', APPKEY_PREFIX:'PE_APP_APPKEY_', DEFAULT_EXPORT_NAME:'Program_Evaluation.docx' };

/* ==================== DATA — SCENARIOS ================== */
const SCENARIOS=[
/* ... (unchanged scenarios list from your message) ... */
{title:"Jefferson Middle School: Discipline, Trust, and a System in Strain", /* content omitted here for brevity in this message, keep full text as in your file */ setting_snapshot:`Jefferson Middle School serves approximately 700 students in a neighborhood undergoing rapid gentrification. Long-standing Black and Latine families are being priced out, while newer families move in with different expectations, communication styles, and relationships to the school. The building is old, with frequent HVAC failures, limited classroom space, and a rotating roster of substitute teachers. Staff shortages are common, and teacher turnover has increased each year for the last three years.

The school leadership is under pressure from the district to "improve behavioral indicators" after a report showed rising suspension rates. Although the district has encouraged schools to explore alternatives to exclusionary practices, no additional staff or training has been provided. Teachers describe their classrooms as crowded and unpredictable, and the social worker has responsibility for crisis response, attendance concerns, and family outreach with very limited time for prevention or programming.

Families often report feeling disconnected from the school. Some describe feeling unwelcome when raising concerns. Others say they do not understand the discipline process or why certain decisions are made. The school attempts family engagement events, but attendance is inconsistent.`, population_snapshot:`The school serves primarily Black and Latine students ages 11 through 14. Many families work multiple jobs, creating challenges for attending meetings or monitoring school communication systems. A significant number of students have recently experienced displacement due to rent increases. Approximately one in six students receives special education services, and many students report varying levels of mistrust toward adults in institutional settings.`, core_problems:`There are conflicting beliefs among staff about what the "real problem" is. Some teachers believe that students have become increasingly defiant and that inconsistent classroom management across staff leads to escalation. Others believe that the zero-tolerance disciplinary policies adopted several years ago are producing more harm than good. Families express confusion and frustration about discipline decisions, and some say they feel judged or misunderstood when they reach out for support.

Administrators feel caught between community expectations, district pressure, and staff fatigue. Teachers feel unsupported and fear that loosening disciplinary responses will lead to loss of control in the classroom. Students say they are suspended for relatively small behaviors, and that adults interpret their communication styles as disrespectful. There is no agreement on what should change or who holds responsibility.`, stakeholder_glimpses:`Teachers: Want calmer classrooms, feel overwhelmed, and believe discipline must be consistent. Some feel blamed for outcomes they cannot control.

Students: Report feeling targeted, misunderstood, and excluded from decisions affecting them. Fear that suspensions damage their academic futures.

Families: Want transparency and fairness. Some feel intimidated in meetings. Others feel staff do not understand cultural norms or communication differences.

Administrators: Worried about district scrutiny, family complaints, and public perception. Want order but lack resources for systemic change.

District Representatives: Emphasize behavioral metrics tied to school performance. Offer limited guidance or support.

School Social Worker: Overextended and unable to address root causes. Wishes for more collaborative systems but lacks authority to change workflows.`, equity_signals:`Racialized discipline patterns, gentrification pressures, inconsistent access to special education services, and limited language-inclusive communication shape the environment. Families with fewer resources often experience greater barriers to advocacy. Tensions between policing in the neighborhood and student safety perceptions affect trust in school authority.`, constraints_resources:`Constraints:
• No new full-time positions available
• Limited time from the social worker for non-crisis programming
• Monthly reporting cycles delay data availability
• Limited physical space for group meetings or restorative practices
• Inconsistent definitions of "incidents" across staff
• Strong district pressure to show improvement without providing resources

Resources:
• A committed core of teachers interested in collaboration
• A bilingual family liaison who is well connected to the community
• After-school time with some flexible space
• Student leadership groups willing to provide feedback
• Existing climate surveys conducted annually`, role:`You are the MSW evaluator and program designer assigned to develop one small, feasible program or practice initiative, along with an evaluation plan, that fits within these constraints and addresses the tensions described. You must consider the perspectives and needs of all stakeholder groups.`},

/* keep the remaining scenarios exactly as in your source (Harbor House Shelter, Prairie County…, … Prism Youth Collective) */
];

/* =============== HELPERS =============== */
function $(id){return document.getElementById(id)}
function escapeHTML(s=''){return s.replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]))}
function normalizeDashes(s=''){return s.replace(/[\u2013\u2014]/g,'-')}
function stripEmojis(s=''){return s.replace(/[\p{Extended_Pictographic}\uFE0F]/gu,'')}
function paragraphsHTML(text=''){
  let t=text.replace(/\r\n/g,'\n'); t=normalizeDashes(t); t=stripEmojis(t);
  return t.split(/\n\s*\n/g).map(p=>`<p>${escapeHTML(p).replace(/\n/g,'<br>')}</p>`).join('')
}
function toast(msg){const el=$('toast');el.textContent=msg;el.classList.add('show');setTimeout(()=>el.classList.remove('show'),1200)}
function nowISO(){return new Date().toISOString()}
function activeIsTyping(){const ae=document.activeElement; if(!ae) return false; const tag=ae.tagName.toLowerCase(); return tag==='textarea'||tag==='input'||ae.isContentEditable}

/* clipboard fallback (HTTPS or file:// safe) */
async function copyTextSafe(txt){
  try{
    if(navigator.clipboard && window.isSecureContext!==false){
      await navigator.clipboard.writeText(txt);
      return true;
    }
  }catch(_){}
  const ta=document.createElement('textarea');
  ta.value=txt; ta.style.position='fixed'; ta.style.opacity='0';
  document.body.appendChild(ta); ta.focus(); ta.select();
  let ok=false; try{ ok=document.execCommand('copy'); }catch(_){}
  ta.remove(); return ok;
}

/* simple hash to skip redundant autosaves */
function hashString(s){ let h=5381; for(let i=0;i<s.length;i++){ h=((h<<5)+h) ^ s.charCodeAt(i); } return (h>>>0).toString(36); }

/* =============== STATE =============== */
let locked=false, currentScenario=null, autosaveTimer=null, lastSavedHash='';

/* =============== INIT =============== */
document.addEventListener('DOMContentLoaded',()=>{
  $('courseTag').textContent=CONFIG.COURSE_TAG;
  bind('btnRandom', onRandomize); bind('btnLock', onLockToggle); bind('btnNew', onNew);
  bind('btnSave', onSave); bind('btnLoad', onLoad);
  bind('btnCopyScenario', onCopyScenario); bind('btnCopyAll', onCopyAll);
  bind('btnExport', onExport); bind('btnPrint', ()=>window.print());

  document.addEventListener('keydown', e=>{
    const modS=(e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='s'; if(modS){e.preventDefault();onSave();return;}
    if(activeIsTyping()) return;
    if(e.altKey&&/r/i.test(e.key)){e.preventDefault();onRandomize();}
    if(e.altKey&&/l/i.test(e.key)){e.preventDefault();onLockToggle();}
    if(e.altKey&&/e/i.test(e.key)){e.preventDefault();onExport();}
    if(e.altKey&&/p/i.test(e.key)){e.preventDefault();window.print();}
  });
});

/* =============== DOM UTIL =============== */
function bind(id,fn){const el=$(id); if(el) el.addEventListener('click',fn)}

/* =============== RANDOMIZE / RENDER =============== */
function onRandomize(){
  if(!SCENARIOS||!SCENARIOS.length){toast('No scenarios available');return;}
  const idx=Math.floor(Math.random()*SCENARIOS.length);
  currentScenario=SCENARIOS[idx];
  renderScenario(currentScenario);
  clearBuilder();
  lastSavedHash='';
  toast('Scenario selected');
}
function renderScenario(s){
  $('scenarioTitle').textContent=s?.title||'Untitled';
  const grid=$('scenarioGrid'); grid.innerHTML='';
  const map={
    'Setting Snapshot':s.setting_snapshot,
    'Population Snapshot':s.population_snapshot,
    'Core Problems or Tensions':s.core_problems,
    'Stakeholder Glimpses':s.stakeholder_glimpses,
    'Equity Signals':s.equity_signals,
    'Known Constraints and Resources':s.constraints_resources,
    'Your Role':s.role
  };
  for(const k in map){
    grid.insertAdjacentHTML('beforeend',
      `<div class="row"><div class="key">${escapeHTML(k)}</div><div class="val">${paragraphsHTML(map[k]||'')}</div></div>`
    );
  }
}

/* =============== LOCK / AUTOSAVE =============== */
function setLocked(v){
  locked=v;
  [...document.querySelectorAll('textarea')].forEach(f=>f.disabled=!locked);
  $('btnLock').textContent=locked?'Unlock':'Lock';
  const chip=$('statusChip'); chip.textContent=locked?'Locked for writing':'Unlocked';
  chip.classList.toggle('locked',locked); chip.classList.toggle('unlocked',!locked);
  if(locked){startAutosave()} else {stopAutosave()}
  lastSavedHash='';
}
function onLockToggle(){ if(!currentScenario){toast('Randomize a scenario first');return;} setLocked(!locked) }
function startAutosave(){ stopAutosave(); autosaveTimer=setInterval(onSave,4000) }
function stopAutosave(){ if(autosaveTimer){clearInterval(autosaveTimer); autosaveTimer=null} }

/* =============== BUILDER =============== */
function clearBuilder(){
  ['f_context','f_design','f_purpose','f_outcomes','f_operational','f_designplan','f_ethics','f_assumptions']
    .forEach(id=>$(id).value='');
}

/* =============== SAVE / LOAD =============== */
function storageKey(){const title=(currentScenario?.title||'UNTITLED').slice(0,50); return CONFIG.APPKEY_PREFIX+title}
function collectData(){
  const fields={
    context:$('f_context').value,
    design:$('f_design').value,
    purpose:$('f_purpose').value,
    outcomes:$('f_outcomes').value,
    operational:$('f_operational').value,
    designplan:$('f_designplan').value,
    ethics:$('f_ethics').value,
    assumptions:$('f_assumptions').value
  };
  return {caseTitle:currentScenario?.title||'', fields, timestamp:nowISO()}
}
function onSave(){ if(!currentScenario){toast('Nothing to save');return;}
  try{
    const payload = JSON.stringify(collectData());
    const h = hashString(payload);
    if(h===lastSavedHash){ return; }
    localStorage.setItem(storageKey(), payload);
    lastSavedHash = h;
    toast('Saved');
  }catch(e){console.error(e);toast('Save failed')}
}
function onLoad(){ if(!currentScenario){toast('Randomize a scenario first');return;}
  const raw=localStorage.getItem(storageKey()); if(!raw){toast('No saved draft');return;}
  try{
    const d=JSON.parse(raw);
    $('f_context').value=d.fields?.context||'';
    $('f_design').value=d.fields?.design||'';
    $('f_purpose').value=d.fields?.purpose||'';
    $('f_outcomes').value=d.fields?.outcomes||'';
    $('f_operational').value=d.fields?.operational||'';
    $('f_designplan').value=d.fields?.designplan||'';
    $('f_ethics').value=d.fields?.ethics||'';
    $('f_assumptions').value=d.fields?.assumptions||'';
    toast('Loaded');
    lastSavedHash='';
  }catch(e){console.error(e);toast('Load failed')}
}

/* =============== COPY / EXPORT =============== */
function plainScenarioText(){
  if(!currentScenario) return 'No scenario selected.';
  const s=currentScenario;
  const kv=[
    ['Title',s.title],['Setting Snapshot',s.setting_snapshot],['Population Snapshot',s.population_snapshot],
    ['Core Problems or Tensions',s.core_problems],['Stakeholder Glimpses',s.stakeholder_glimpses],
    ['Equity Signals',s.equity_signals],['Known Constraints and Resources',s.constraints_resources],['Your Role',s.role]
  ];
  return kv.map(([k,v])=>`${k}:\n${normalizeDashes(stripEmojis(v||''))}`).join('\n\n')
}
function plainAllText(){
  const d=collectData();
  return `${plainScenarioText()}

Scenario Context & Stakeholders:
${d.fields.context}

Your Program or Practice Design:
${d.fields.design}

Evaluation Purpose & Questions:
${d.fields.purpose}

Outcomes (Conceptualization):
${d.fields.outcomes}

Operationalization & Data Sources:
${d.fields.operational}

Evaluation Design Plan:
${d.fields.designplan}

Ethics, Power, Limitations & Communication:
${d.fields.ethics}

Assumptions:
${d.fields.assumptions}

Saved: ${d.timestamp}`
}
async function onCopyScenario(){
  const ok = await copyTextSafe(plainScenarioText());
  toast(ok?'Scenario copied':'Copy failed');
}
async function onCopyAll(){
  const ok = await copyTextSafe(plainAllText());
  toast(ok?'All copied':'Copy failed');
}

function onExport(){
  if(!currentScenario){toast('Randomize a scenario first');return;}
  const d=collectData(), s=currentScenario;
  const gridHTML=`<table border="1" cellpadding="6" cellspacing="0" style="border-collapse:collapse;width:100%">
    ${Object.entries({
      'Setting Snapshot':s.setting_snapshot,
      'Population Snapshot':s.population_snapshot,
      'Core Problems or Tensions':s.core_problems,
      'Stakeholder Glimpses':s.stakeholder_glimpses,
      'Equity Signals':s.equity_signals,
      'Known Constraints and Resources':s.constraints_resources,
      'Your Role':s.role
    }).map(([k,v])=>`<tr><td style="width:260px;font-weight:bold;background:#f5f5f5">${escapeHTML(k)}</td><td>${paragraphsHTML(v||'')}</td></tr>`).join('')}
  </table>`;
  const html=`<h1>${escapeHTML(s.title||'Untitled')}</h1>
    <p><strong>${escapeHTML(CONFIG.COURSE_TAG)}</strong></p>
    <h2>Scenario Details</h2>${gridHTML}
    <h2>Scenario Context & Stakeholders</h2><p>${escapeHTML(d.fields.context).replace(/\n/g,'<br>')}</p>
    <h2>Your Program or Practice Design</h2><p>${escapeHTML(d.fields.design).replace(/\n/g,'<br>')}</p>
    <h2>Evaluation Purpose & Questions</h2><p>${escapeHTML(d.fields.purpose).replace(/\n/g,'<br>')}</p>
    <h2>Outcomes (Conceptualization)</h2><p>${escapeHTML(d.fields.outcomes).replace(/\n/g,'<br>')}</p>
    <h2>Operationalization & Data Sources</h2><p>${escapeHTML(d.fields.operational).replace(/\n/g,'<br>')}</p>
    <h2>Evaluation Design Plan</h2><p>${escapeHTML(d.fields.designplan).replace(/\n/g,'<br>')}</p>
    <h2>Ethics, Power, Limitations & Communication</h2><p>${escapeHTML(d.fields.ethics).replace(/\n/g,'<br>')}</p>
    ${d.fields.assumptions?.trim()?`<h2>Assumptions</h2><p>${escapeHTML(d.fields.assumptions).replace(/\n/g,'<br>')}</p>`:''}
    <p><em>Exported: ${escapeHTML(d.timestamp)}</em></p>`;
  window.htmlDocx.asBlobAsync(html).then(function(blob){
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    const safe=(s.title||'Program_Evaluation').replace(/[^\w\-]+/g,'_').slice(0,80)+'.docx';
    a.download=safe||CONFIG.DEFAULT_EXPORT_NAME;
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{URL.revokeObjectURL(a.href);a.remove();},0);
    toast('Exported .docx');
  }).catch(function(err){
    console.error(err); toast('Export failed');
  });
}
function onNew(){clearBuilder(); lastSavedHash=''; toast('Cleared')}
</script>

<!-- ===== DOCX exporter shim (pure WordprocessingML, safe scoping) ===== -->
<script>
/* all internals wrapped to avoid leaking globals like CRC_TABLE */
(() => {
  /* --- tiny UTF-8 + ZIP (store) builder --- */
  function utf8Bytes(str){str=String(str);const b=[];for(let i=0;i<str.length;i++){let c=str.charCodeAt(i);if(c>=0xD800&&c<=0xDBFF&&i+1<str.length){const c2=str.charCodeAt(++i);if((c2&0xFC00)===0xDC00){c=0x10000+((c-0xD800)<<10)+(c2-0xDC00)}else{i--}}if(c<=0x7F)b.push(c);else if(c<=0x7FF)b.push(0xC0|(c>>6),0x80|(c&0x3F));else if(c<=0xFFFF)b.push(0xE0|(c>>12),0x80|((c>>6)&0x3F),0x80|(c&0x3F));else b.push(0xF0|(c>>18),0x80|((c>>12)&0x3F),0x80|((c>>6)&0x3F),0x80|(c&0x3F))}return new Uint8Array(b)}
  const CRC_TABLE=(()=>{let c,t=[];for(let n=0;n<256;n++){c=n;for(let k=0;k<8;k++){c=((c&1)?(0xEDB88320^(c>>>1)):(c>>>1))}t[n]=c>>>0}return t})();
  function crc32(u8){let c=0^(-1);for(let i=0;i<u8.length;i++){c=(c>>>8)^CRC_TABLE[(c^u8[i])&255]}return (c^(-1))>>>0}
  function le16(n){return new Uint8Array([n&255,(n>>8)&255])}
  function le32(n){return new Uint8Array([n&255,(n>>8)&255,(n>>16)&255,(n>>24)&255])}
  function cat(chunks){const L=chunks.reduce((a,b)=>a+b.length,0);const out=new Uint8Array(L);let o=0;for(const c of chunks){out.set(c,o);o+=c.length}return out}
  function zipBlobSync(files,mime){const LFH=0x04034b50,CDH=0x02014b50,EOCD=0x06054b50,ver=20,gpbf=0x0800,method=0;const now=new Date();const dosTime=((now.getHours()<<11)|(now.getMinutes()<<5)|(Math.floor(now.getSeconds()/2)));const dosDate=(((now.getFullYear()-1980)<<9)|((now.getMonth()+1)<<5)|now.getDate());const lfhChunks=[];const centrals=[];let offset=0;const headers=[];for(const f of files){const name=utf8Bytes(f.name);const data=f.data;const sum=crc32(data);const lfh=cat([le32(LFH),le16(ver),le16(gpbf),le16(method),le16(dosTime),le16(dosDate),le32(sum),le32(data.length),le32(data.length),le16(name.length),le16(0),name,data]);lfhChunks.push(lfh);headers.push({name,sum,size:data.length,offset,dosTime,dosDate});offset+=lfh.length}const startCD=offset;for(const h of headers){const cdh=cat([le32(CDH),le16(0x033F),le16(0x003F),le16(gpbf),le16(method),le16(h.dosTime),le16(h.dosDate),le32(h.sum),le32(h.size),le32(h.size),le16(h.name.length),le16(0),le16(0),le16(0),le16(0),le32(0),le32(h.offset),h.name]);centrals.push(cdh);offset+=cdh.length}const centralDir=cat(centrals);const end=cat([le32(EOCD),le16(0),le16(0),le16(headers.length),le16(headers.length),le32(centralDir.length),le32(startCD),le16(0)]);const zip=cat([...lfhChunks,centralDir,end]);return new Blob([zip],{type:mime||'application/zip'})}

  /* ---- Minimal HTML -> WordprocessingML mapper (headings, paragraphs, <br>, simple tables) ---- */
  function sanitize(text){return String(text||"").replace(/[\u2013\u2014]/g,"-").replace(/[\p{Extended_Pictographic}\uFE0F]/gu,"")}
  function esc(s){return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}
  function runText(t){return `<w:r><w:t xml:space="preserve">${esc(t)}</w:t></w:r>`}
  function p(children,style){return `<w:p>${style?`<w:pPr><w:pStyle w:val="${style}"/></w:pPr>`:""}${children||""}</w:p>`}
  function heading(text,level){const map={1:"Heading1",2:"Heading2",3:"Heading3"};return p(runText(text),map[level]||"Heading2")}

  /* FIXED: use <w:br/> for line breaks, never open/close <w:p> inside another <w:p> */
  function paragraphFromHTML(node){
    let out = "";
    node.childNodes.forEach(ch => {
      if (ch.nodeType === 3) {
        out += runText(ch.nodeValue || "");
      } else if (ch.nodeName === "BR") {
        out += '<w:r><w:br/></w:r>';
      } else if (ch.nodeType === 1) {
        out += paragraphFromHTML(ch);
      }
    });
    return out;
  }
  function para(text){return p(runText(text),null)}
  function parseHTMLtoDoc(xmlString){
    const dom=new DOMParser().parseFromString(`<div>${xmlString}</div>`,'text/html');
    const root=dom.body.firstChild||dom.body;
    const blocks=root.querySelectorAll('h1,h2,h3,p,table');
    let bodyParts=[];
    if(blocks.length===0){ bodyParts=[para(sanitize(root.textContent||''))] }
    else {
      blocks.forEach(el=>{
        const tag=el.tagName.toLowerCase();
        if(tag==='h1'){bodyParts.push(heading(el.textContent||'',1))}
        else if(tag==='h2'){bodyParts.push(heading(el.textContent||'',2))}
        else if(tag==='h3'){bodyParts.push(heading(el.textContent||'',3))}
        else if(tag==='p'){bodyParts.push(p(paragraphFromHTML(el),null))}
        else if(tag==='table'){
          const rows=[...el.querySelectorAll('tr')].map(tr=>{
            const cells=[...tr.children].map(td=>{
              const txt=td.textContent||'';
              return `<w:tc><w:tcPr/><w:p><w:r><w:t xml:space="preserve">${esc(txt)}</w:t></w:r></w:p></w:tc>`;
            }).join('');
            return `<w:tr>${cells}</w:tr>`;
          }).join('');
          bodyParts.push(`<w:tbl><w:tblPr/><w:tblGrid/>${rows}</w:tbl>`);
        }
      });
    }
    return bodyParts.join('');
  }
  function buildDocxFromHTML(htmlInput){
    const safe = sanitize(htmlInput);
    const docBody = parseHTMLtoDoc(safe);
    const styles=`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
    <w:styles xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">
      <w:style w:type="paragraph" w:styleId="Heading1"><w:name w:val="heading 1"/><w:basedOn w:val="Normal"/><w:pPr><w:keepNext/><w:keepLines/></w:pPr><w:rPr><w:b/><w:sz w:val="32"/></w:rPr></w:style>
      <w:style w:type="paragraph" w:styleId="Heading2"><w:name w:val="heading 2"/><w:basedOn w:val="Normal"/><w:pPr><w:keepNext/><w:keepLines/></w:pPr><w:rPr><w:b/><w:sz w:val="28"/></w:rPr></w:style>
      <w:style w:type="paragraph" w:styleId="Heading3"><w:name w:val="heading 3"/><w:basedOn w:val="Normal"/><w:pPr><w:keepNext/><w:keepLines/></w:pPr><w:rPr><w:b/><w:sz w:val="24"/></w:rPr></w:style>
    </w:styles>`;
    const contentTypes=`<?xml version="1.0" encoding="UTF-8"?>
    <Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">
      <Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>
      <Default Extension="xml" ContentType="application/xml"/>
      <Override PartName="/word/document.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml"/>
      <Override PartName="/word/styles.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.styles+xml"/>
    </Types>`;
    const rootRels=`<?xml version="1.0" encoding="UTF-8"?>
    <Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
      <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="word/document.xml"/>
    </Relationships>`;
    const docRels=`<?xml version="1.0" encoding="UTF-8"?>
    <Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
      <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/styles" Target="styles.xml"/>
    </Relationships>`;
    const documentXML=`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
    <w:document xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">
      <w:body>${docBody}<w:sectPr/></w:body>
    </w:document>`;
    const files=[
      {name:'[Content_Types].xml',data:utf8Bytes(contentTypes)},
      {name:'_rels/.rels',data:utf8Bytes(rootRels)},
      {name:'word/document.xml',data:utf8Bytes(documentXML)},
      {name:'word/_rels/document.xml.rels',data:utf8Bytes(docRels)},
      {name:'word/styles.xml',data:utf8Bytes(styles)}
    ];
    return zipBlobSync(files,'application/vnd.openxmlformats-officedocument.wordprocessingml.document');
  }

  /* public shim */
  const api=window.htmlDocx||{};
  api.asBlob=function(html){ return buildDocxFromHTML(html); };
  api.asBlobAsync=function(html){ return Promise.resolve(buildDocxFromHTML(html)); };
  window.htmlDocx=api;
})();
</script>

</body>
</html>
