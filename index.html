<!DOCTYPE html>
<html lang="en">
<head>
  <!-- TODO(dev): Debug the original EBP Randomizer page for the reported functionality issue. -->
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Program Evaluation Generator</title>
  <style>
    :root{ --bg:#f6f7fb;--card:#ffffff;--ink:#111827;--muted:#6b7280;--primary:#6d28d9;--primary-ink:#fff;--ring:#c4b5fd;--ok:#059669;--warn:#b45309;}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";color:var(--ink);background:var(--bg)}
    .container{max-width:1200px;margin:0 auto;padding:20px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px}
    .title{font-weight:800;font-size:20px}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px}
    button{appearance:none;border:1px solid transparent;background:var(--primary);color:var(--primary-ink);padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer}
    button.ghost{background:transparent;color:var(--ink);border-color:#e5e7eb}
    button.secondary{background:#111827;color:#fff}
    button:disabled{opacity:.55;cursor:not-allowed}
    .grid{display:grid;grid-template-columns:1fr 1.3fr;gap:16px}
    @media (max-width: 960px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 1px 2px rgba(0,0,0,.04);padding:16px}
    .card h2{margin:0 0 8px 0;font-size:18px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .field{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
    label{font-size:12px;color:#374151;font-weight:700}
    .hint{font-size:11px;color:#6b7280}
    input,textarea{width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;color:var(--ink);font:inherit}
    textarea{min-height:120px;resize:vertical}
    .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid #e5e7eb;border-radius:999px;padding:6px 10px;font-size:12px}
    .chip{background:#f3f4f6;border:1px solid #e5e7eb;border-radius:999px;padding:6px 10px;font-size:12px}
    .hr{height:1px;background:#eef0f4;margin:12px 0}
    .status{font-size:12px}
    .footer{margin-top:14px;font-size:12px;color:var(--muted);display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .focus-ring:focus{outline:3px solid var(--ring);outline-offset:2px}
    .spin{animation:spin 1s linear infinite;display:inline-block} @keyframes spin{to{transform:rotate(360deg)}}
    .hidden{display:none}
    .scenario p{margin:0 0 10px 0}
    .kvs{display:grid;grid-template-columns:200px 1fr;gap:8px}
    .kvs .muted{align-self:start}
  </style>
</head>
<body>
<div class="container">
  <header>
    <div class="row">
      <div class="title" id="siteTitle">Program Evaluation Generator</div>
      <span class="badge" id="siteSubtitle">SOW5404 ‚Ä¢ Spring 2026 ‚Ä¢ No login ‚Ä¢ Export Word / Copy Text</span>
    </div>
    <div class="toolbar" role="toolbar" aria-label="Main">
      <button id="btnRandom" class="focus-ring" title="Alt+R ‚Äî Randomize a scenario">üé≤ Randomize</button>
      <button id="btnLock" class="ghost focus-ring" title="Alt+L ‚Äî Lock/unlock the current scenario">üîí Lock</button>
      <button id="btnNew" class="ghost focus-ring" title="Start fresh">üßº New</button>
      <button id="btnSave" class="ghost focus-ring" title="Save to this browser">üíæ Save</button>
      <button id="btnLoad" class="ghost focus-ring" title="Load last draft">üìÇ Load</button>
      <button id="btnCopyScenario" class="ghost focus-ring" title="Copy scenario as plain text">üßæ Copy Scenario</button>
      <button id="btnExport" class="secondary focus-ring" title="Alt+E ‚Äî Export to Word">‚¨áÔ∏è Export Word</button>
      <button id="btnCopy" class="ghost focus-ring" title="Copy all as plain text">üìã Copy Text</button>
      <button id="btnPrint" class="ghost focus-ring" title="Alt+P ‚Äî Print">üñ®Ô∏è Print</button>
      <!-- Removed Import/Export JSON buttons to prevent confusion -->
      <input id="fileInput" type="file" accept="application/json" class="hidden"/>
    </div>
  </header>

  <div class="grid" id="app">
    <section class="card" aria-labelledby="caseTitle">
      <h2 id="caseTitle">Scenario</h2>
      <div id="caseEmpty" class="muted">Click <strong>Randomize</strong> to draw a scenario. Lock to begin writing.</div>

      <div id="caseWrap" hidden>
        <div class="row" style="justify-content:space-between;align-items:flex-start">
          <div class="row" style="gap:8px;align-items:center">
            <div class="badge hidden" id="caseId">ID</div>
            <div class="chip hidden" id="caseTitleChip"></div>
          </div>
          <div class="status" id="lockStatus"></div>
        </div>

        <div class="hr"></div>
        <div class="kvs scenario">
          <div class="muted">Title</div><div id="vTitle"></div>
          <div class="muted">Setting snapshot</div><div id="vSetting"></div>
          <div class="muted">Population snapshot</div><div id="vPopulation"></div>
          <div class="muted">Core problems / tensions</div><div id="vCore"></div>
          <div class="muted">Stakeholder glimpses</div><div id="vStake"></div>
          <div class="muted">Structural / equity signals</div><div id="vEquity"></div>
          <div class="muted">Known constraints / resources</div><div id="vConstraints"></div>
          <div class="muted">Your role</div><div id="vRole"></div>
        </div>
      </div>
    </section>

    <section class="card" aria-labelledby="builderTitle">
      <h2 id="builderTitle">Program Evaluation Builder</h2>
      <div id="lockGate" class="muted">Lock a scenario to enable editing.</div>
      <div id="builder" hidden>
        <div class="field">
          <label for="fContext">1) Scenario Context & Stakeholders</label>
          <div class="hint">Summarize setting, population, core problems you will focus on. Name key stakeholders and what each wants. Include 1‚Äì2 structural/equity factors.</div>
          <textarea id="fContext"></textarea>
          <div class="row"><span class="status" id="cntContext">0 words</span></div>
        </div>

        <div class="field">
          <label for="fDesign">2) Your Program or Practice Design</label>
          <div class="hint">Describe what you propose, who it is for, components (format, frequency, roles), and a short theory of change.</div>
          <textarea id="fDesign"></textarea>
          <div class="row"><span class="status" id="cntDesign">0 words</span></div>
        </div>

        <div class="field">
          <label for="fPurpose">3) Evaluation Purpose & Questions</label>
          <div class="hint">Why evaluate now and what decisions it will inform. Add 2‚Äì3 clear evaluation questions (include at least one outcome and one experience/access/structural).</div>
          <textarea id="fPurpose"></textarea>
          <div class="row"><span class="status" id="cntPurpose">0 words</span></div>
        </div>

        <div class="field">
          <label for="fOutcomes">4) Outcomes (Conceptualization)</label>
          <div class="hint">Name 2‚Äì3 outcomes/phenomena. Define in context. Contrast with policy/system definitions.</div>
          <textarea id="fOutcomes"></textarea>
          <div class="row"><span class="status" id="cntOutcomes">0 words</span></div>
        </div>

        <div class="field">
          <label for="fMeasures">5) Operationalization & Data Sources</label>
          <div class="hint">For each outcome, propose at least two measures with data source/level, pros/cons, equity implications.</div>
          <textarea id="fMeasures"></textarea>
          <div class="row"><span class="status" id="cntMeasures">0 words</span></div>
        </div>

        <div class="field">
          <label for="fDesignPlan">6) Evaluation Design Plan</label>
          <div class="hint">Design type, who is included, when data are collected, and a brief map of Questions ‚Üí Outcomes ‚Üí Measures. Note feasibility.</div>
          <textarea id="fDesignPlan"></textarea>
          <div class="row"><span class="status" id="cntDesignPlan">0 words</span></div>
        </div>

        <div class="field">
          <label for="fEthics">7) Ethics, Power, Limitations & Communication</label>
          <div class="hint">How data help vs harm, power/surveillance risks, structural factors, at least 2 limitations, and a 1‚Äì2 sentence participant message.</div>
          <textarea id="fEthics"></textarea>
          <div class="row"><span class="status" id="cntEthics">0 words</span></div>
        </div>

        <div class="field">
          <label for="fAssumptions">Assumptions I am Making (optional)</label>
          <div class="hint">Note reasonable assumptions due to missing or ambiguous details.</div>
          <textarea id="fAssumptions"></textarea>
        </div>

        <div class="hr"></div>
        <div class="row" style="justify-content:space-between">
          <div class="badge">Progress</div>
          <div id="progress" class="status">0/7 sections with 100+ words</div>
        </div>
      </div>
    </section>
  </div>

  <div class="footer">
    <span>Autosave:</span><span id="saveStatus">idle</span>
    <span class="muted">‚Ä¢</span><span id="tip">SOW5404 ‚Ä¢ Spring 2026 ‚Ä¢ Alt+R = Randomize, Alt+L = Lock, Alt+E = Export Word.</span>
  </div>
</div>

<script>
  const CONFIG = {
    siteTitle: "Program Evaluation Generator",
    siteSubtitle: "SOW5404 ‚Ä¢ Spring 2026 ‚Ä¢ No login ‚Ä¢ Export Word / Copy Text",
    exportFileName: "SOW5404_Spring_2026_Program_Evaluation.doc",
    courseHeader: "SOW5404 ‚Ä¢ Spring 2026"
  };

  // Utils
  const noDash=(s)=>(s||'').toString().replace(/[‚Äî‚Äì]/g,'-');
  const stripDashesDeep=(v)=>Array.isArray(v)?v.map(stripDashesDeep):v&&typeof v==='object'?Object.fromEntries(Object.entries(v).map(([k,val])=>[k,stripDashesDeep(val)])):typeof v==='string'?noDash(v):v;
  const $=(sel)=>document.querySelector(sel);
  const nowISO=()=>new Date().toISOString();
  const wordCount=(s)=>(s||"").trim().split(/\s+/).filter(Boolean).length;
  const debounce=(fn,ms=800)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn.apply(null,a),ms);};};
  const escapeHtml=s=>(s||'').replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));
  function paragraphsHTML(text){ const safe=noDash(text||'').replace(/\r\n/g,'\n'); const blocks=safe.split(/\n\s*\n/).map(t=>t.trim()).filter(Boolean); return blocks.map(b=>`<p>${escapeHtml(b)}</p>`).join(''); }

  // Data (15 scenarios ‚Äì keep your full set here; truncated in this snippet for space)
  let SCENARIOS = stripDashesDeep(
    [{"title":"Discipline at Jefferson Middle: Suspensions and ‚ÄúDefiance‚Äù","setting_snapshot":"Jefferson Middle School is a large, majority-Black public school in an urban district. The building is old, some classroom windows are painted shut, and the heaters rattle in winter. Hallways are crowded during every class change. The school has one full-time social worker, a part-time behavior specialist shared with another campus, and a school resource officer (SRO) assigned three days a week.","population_snapshot":"Most students live within a 3‚Äì4 mile radius. Many caregivers work variable shifts in healthcare, service, or warehouse jobs. About 80% of students qualify for free/reduced lunch. The ‚Äúhigh needs‚Äù roster combines students with IEPs, 504 plans, and those with 5+ office referrals; Black students and students with disabilities are overrepresented on that list and in suspension data.","core_problems":"Over the past two years, Jefferson‚Äôs out-of-school suspensions have climbed overall and are now above the district average. The largest categories are ‚Äúdefiance,‚Äù ‚Äúdisruption,‚Äù and ‚Äúnoncompliance.‚Äù Teachers describe write-ups for refusing to put away phones, walking out of class, and hallway conflicts that escalate into suspensions. The social worker is called often to de-escalate student-teacher conflicts. Many frequent flyers have recent stressors (housing changes, caregiver illness, community violence) that rarely appear in discipline records. Teachers report burnout and say ‚Äúnothing works,‚Äù while families express frustration about fairness and communication. The district flagged Jefferson for disproportionate discipline and demanded a plan.","stakeholder_glimpses":"Principal: Wants to reduce suspensions without alienating staff and to address disproportionality; fears teacher turnover.\nTeachers: Mixed views, with some wanting ‚Äúclear consequences‚Äù and others asking for more support, coaching, and consistency.\nStudents: Report feeling targeted or misunderstood; some avoid school due to ‚Äúdrama‚Äù and adult interactions.\nFamilies: Mixed trust in the school; some feel meetings are for ‚Äúbeing told,‚Äù not problem-solving together.\nDistrict leaders: Watch suspension numbers, disproportionality, attendance, and school climate as key metrics; also attuned to legal risk.","equity_signals":"Racial and disability disparities in referrals and suspensions; vague categories rely on adult interpretation; police presence on campus; limited youth-friendly mental health services; accountability pressures that value ‚Äúorder‚Äù and test scores over relationship-building.","constraints_resources":"Limited space for new programs; one social worker and a part-time behavior specialist; an SRO is on campus three days/week. Mandatory PD hours are already packed. There is a small, one-year ‚Äúinnovation‚Äù grant up to $10,000. A local youth nonprofit is interested in partnering but not yet formally connected.","role":"As the MSW social worker/evaluator, propose a specific, realistic practice change and outline how you will evaluate whether it helps."}
      /* ‚Ä¶ include remaining 14 scenario objects exactly as before ‚Ä¶ */
    ]
  );

  // State & els
  let current=null, locked=false; let showIds=false;
  const F={context:$('#fContext'),design:$('#fDesign'),purpose:$('#fPurpose'),outcomes:$('#fOutcomes'),measures:$('#fMeasures'),designPlan:$('#fDesignPlan'),ethics:$('#fEthics'),assumptions:$('#fAssumptions')};
  const els={caseEmpty:$('#caseEmpty'),caseWrap:$('#caseWrap'),caseId:$('#caseId'),lockStatus:$('#lockStatus'),caseTitleChip:$('#caseTitleChip'),vTitle:$('#vTitle'),vSetting:$('#vSetting'),vPopulation:$('#vPopulation'),vCore:$('#vCore'),vStake:$('#vStake'),vEquity:$('#vEquity'),vConstraints:$('#vConstraints'),vRole:$('#vRole'),lockGate:$('#lockGate'),builder:$('#builder'),saveStatus:$('#saveStatus'),progress:$('#progress')};

  (function applyConfig(){ $('#siteTitle').textContent=CONFIG.siteTitle; document.title=CONFIG.siteTitle; $('#siteSubtitle').textContent=CONFIG.siteSubtitle; })();
  function applyShowIds(){ const m=showIds?'remove':'add'; els.caseId.classList[m]('hidden'); els.caseTitleChip.classList[m]('hidden'); }
  function updateLockUi(){ els.lockStatus.innerHTML=locked?'<span class="ok">Locked for writing</span>':'<span class="warn">Unlocked</span>'; $('#btnLock').textContent=locked?'üîì Unlock':'üîí Lock'; els.lockGate.hidden=locked; els.builder.hidden=!locked; }

  function renderCase(){
    if(!current){ els.caseWrap.hidden=true; els.caseEmpty.hidden=false; return; }
    els.caseEmpty.hidden=false; els.caseWrap.hidden=false;
    $('#caseId').textContent=current.id||''; $('#caseTitleChip').textContent=noDash(current.title); els.vTitle.textContent=noDash(current.title);
    els.vSetting.innerHTML=paragraphsHTML(current.setting_snapshot);
    els.vPopulation.innerHTML=paragraphsHTML(current.population_snapshot);
    els.vCore.innerHTML=paragraphsHTML(current.core_problems);
    els.vStake.innerHTML=paragraphsHTML(current.stakeholder_glimpses);
    els.vEquity.innerHTML=paragraphsHTML(current.equity_signals);
    els.vConstraints.innerHTML=paragraphsHTML(current.constraints_resources);
    els.vRole.textContent=noDash(current.role);
    applyShowIds(); updateLockUi();
  }

  function randomize(){
    const b=$('#btnRandom'); b.disabled=true; b.innerHTML='<span class="spin">üé≤</span> Rolling...';
    setTimeout(()=>{ const idx=Math.floor(Math.random()*SCENARIOS.length); current=SCENARIOS[idx]; locked=false; clearAllFields(); renderCase(); b.disabled=false; b.textContent='üé≤ Randomize'; toast('New scenario drawn. Review and lock to start.'); },600);
  }
  function toggleLock(){ if(!current){ toast('Draw a scenario first.'); return; } locked=!locked; updateLockUi(); if(locked){ loadDraft(); } }
  function clearAllFields(){ Object.values(F).forEach(el=>{ if(el) el.value=''; }); updateCounters(); }

  function updateCounters(){
    document.getElementById('cntContext').textContent=`${wordCount(F.context.value)} words`;
    document.getElementById('cntDesign').textContent=`${wordCount(F.design.value)} words`;
    document.getElementById('cntPurpose').textContent=`${wordCount(F.purpose.value)} words`;
    document.getElementById('cntOutcomes').textContent=`${wordCount(F.outcomes.value)} words`;
    document.getElementById('cntMeasures').textContent=`${wordCount(F.measures.value)} words`;
    document.getElementById('cntDesignPlan').textContent=`${wordCount(F.designPlan.value)} words`;
    document.getElementById('cntEthics').textContent=`${wordCount(F.ethics.value)} words`;
    const hits=[F.context,F.design,F.purpose,F.outcomes,F.measures,F.designPlan,F.ethics].filter(x=>wordCount(x.value)>=100).length;
    els.progress.textContent=`${hits}/7 sections with 100+ words`;
  }

  // Autosave
  const autoKey=()=> current ? `PE_NOTE_${noDash(current.title).slice(0,40)}` : 'PE_NOTE_UNSET';
  const autosave=debounce(()=>{ if(!current||!locked) return; const data={case:current,locked,fields:{context:F.context.value,design:F.design.value,purpose:F.purpose.value,outcomes:F.outcomes.value,measures:F.measures.value,designPlan:F.designPlan.value,ethics:F.ethics.value,assumptions:F.assumptions.value},ts:nowISO()}; try{ localStorage.setItem(autoKey(), JSON.stringify(data)); els.saveStatus.textContent=`saved ${new Date().toLocaleTimeString()}`; }catch{ els.saveStatus.textContent='save failed'; } },1200);
  function loadDraft(){ const raw=localStorage.getItem(autoKey()); if(!raw){ els.saveStatus.textContent='no draft'; return; } try{ const d=JSON.parse(raw); F.context.value=d.fields?.context||''; F.design.value=d.fields?.design||''; F.purpose.value=d.fields?.purpose||''; F.outcomes.value=d.fields?.outcomes||''; F.measures.value=d.fields?.measures||''; F.designPlan.value=d.fields?.designPlan||''; F.ethics.value=d.fields?.ethics||''; F.assumptions.value=d.fields?.assumptions||''; updateCounters(); els.saveStatus.textContent=`loaded draft (${new Date(d.ts).toLocaleString()})`; }catch{ els.saveStatus.textContent='load failed'; } }

  // Export / Copy / Print
  function buildDocHtml(){
    if(!current) return '<!doctype html><html><head><meta charset="utf-8"><title>Program Evaluation</title></head><body><p>No scenario selected.</p></body></html>';
    const esc=(s)=>escapeHtml(noDash((s||'').toString()));
    const h=[];
    h.push('<!doctype html><html><head><meta charset="utf-8"><title>Program Evaluation</title>');
    h.push('<style>body{font-family:Calibri,Arial,Helvetica,sans-serif;line-height:1.45;color:#111} h1,h2,h3{margin:0 0 6px} h1{font-size:22px} h2{font-size:18px;margin-top:16px} p{margin:0 0 10px 0} ul{margin:4px 0 8px 18px} .k{color:#374151} .small{color:#555;font-size:12px} @page{margin:1in}</style></head><body>');
    h.push(`<h1>${esc(CONFIG.siteTitle)}</h1>`);
    h.push(`<p class="small">${esc(CONFIG.courseHeader)}</p>`);
    h.push('<h2>Scenario</h2><ul>');
    h.push('<li><span class="k">Title:</span> '+esc(current.title)+'</li>');
    h.push('</ul>');
    h.push('<h3>Setting snapshot</h3>'+paragraphsHTML(current.setting_snapshot));
    h.push('<h3>Population snapshot</h3>'+paragraphsHTML(current.population_snapshot));
    h.push('<h3>Core problems / tensions</h3>'+paragraphsHTML(current.core_problems));
    h.push('<h3>Stakeholder glimpses</h3>'+paragraphsHTML(current.stakeholder_glimpses));
    h.push('<h3>Structural / equity signals</h3>'+paragraphsHTML(current.equity_signals));
    h.push('<h3>Known constraints / resources</h3>'+paragraphsHTML(current.constraints_resources));
    h.push('<h3>Your role</h3><p>'+esc(current.role)+'</p>');
    h.push('<h2>1) Scenario Context & Stakeholders</h2><p>'+esc($('#fContext').value).replace(/\n/g,'<br>')+'</p>');
    h.push('<h2>2) Your Program or Practice Design</h2><p>'+esc($('#fDesign').value).replace(/\n/g,'<br>')+'</p>');
    h.push('<h2>3) Evaluation Purpose & Questions</h2><p>'+esc($('#fPurpose').value).replace(/\n/g,'<br>')+'</p>');
    h.push('<h2>4) Outcomes (Conceptualization)</h2><p>'+esc($('#fOutcomes').value).replace(/\n/g,'<br>')+'</p>');
    h.push('<h2>5) Operationalization & Data Sources</h2><p>'+esc($('#fMeasures').value).replace(/\n/g,'<br>')+'</p>');
    h.push('<h2>6) Evaluation Design Plan</h2><p>'+esc($('#fDesignPlan').value).replace(/\n/g,'<br>')+'</p>');
    h.push('<h2>7) Ethics, Power, Limitations & Communication</h2><p>'+esc($('#fEthics').value).replace(/\n/g,'<br>')+'</p>');
    const ass=$('#fAssumptions').value; if(ass){ h.push('<h2>Assumptions</h2><p>'+esc(ass).replace(/\n/g,'<br>')+'</p>'); }
    h.push('<p class="small">Generated '+new Date().toLocaleString()+'</p>');
    h.push('</body></html>');
    return h.join('');
  }
  function buildPlainText(){
    if(!current) return 'No scenario selected.';
    const lines=[];
    lines.push(CONFIG.siteTitle, CONFIG.courseHeader, '');
    lines.push('Scenario');
    lines.push(`- Title: ${noDash(current.title)}`,'');
    lines.push('Setting snapshot'); lines.push(noDash(current.setting_snapshot),'');
    lines.push('Population snapshot'); lines.push(noDash(current.population_snapshot),'');
    lines.push('Core problems / tensions'); lines.push(noDash(current.core_problems),'');
    lines.push('Stakeholder glimpses'); lines.push(noDash(current.stakeholder_glimpses),'');
    lines.push('Structural / equity signals'); lines.push(noDash(current.equity_signals),'');
    lines.push('Known constraints / resources'); lines.push(noDash(current.constraints_resources),'');
    lines.push('Your role'); lines.push(noDash(current.role),'');
    lines.push('1) Scenario Context & Stakeholders'); lines.push($('#fContext').value,'');
    lines.push('2) Your Program or Practice Design'); lines.push($('#fDesign').value,'');
    lines.push('3) Evaluation Purpose & Questions'); lines.push($('#fPurpose').value,'');
    lines.push('4) Outcomes (Conceptualization)'); lines.push($('#fOutcomes').value,'');
    lines.push('5) Operationalization & Data Sources'); lines.push($('#fMeasures').value,'');
    lines.push('6) Evaluation Design Plan'); lines.push($('#fDesignPlan').value,'');
    lines.push('7) Ethics, Power, Limitations & Communication'); lines.push($('#fEthics').value,'');
    const ass=$('#fAssumptions').value; if(ass){ lines.push('Assumptions'); lines.push(ass,''); }
    lines.push(`Generated ${new Date().toLocaleString()}`);
    return lines.join('\n');
  }
  function downloadWord(){
    const html=buildDocHtml();
    const blob=new Blob([html],{type:'application/msword'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=CONFIG.exportFileName; a.click(); URL.revokeObjectURL(url);
    toast('Word file downloaded.');
  }
  async function copyPlain(){ try{ await navigator.clipboard.writeText(buildPlainText()); toast('Copied as plain text.'); } catch{ toast('Copy failed. Use Export Word instead.'); } }
  async function copyScenario(){
    if(!current){ toast('Draw a scenario first.'); return; }
    const txt=[
      `Title: ${noDash(current.title)}`,
      `Setting snapshot: ${noDash(current.setting_snapshot)}`,
      `Population snapshot: ${noDash(current.population_snapshot)}`,
      `Core problems / tensions: ${noDash(current.core_problems)}`,
      `Stakeholder glimpses: ${noDash(current.stakeholder_glimpses)}`,
      `Structural / equity signals: ${noDash(current.equity_signals)}`,
      `Known constraints / resources: ${noDash(current.constraints_resources)}`,
      `Your role: ${noDash(current.role)}`
    ].join('\n\n');
    try{ await navigator.clipboard.writeText(txt); toast('Scenario copied.'); } catch{ toast('Copy failed.'); }
  }
  function printPage(){ window.print(); }

  // Toast
  let toastTimer=null; const toastDiv=document.createElement('div');
  toastDiv.style.position='fixed'; toastDiv.style.bottom='16px'; toastDiv.style.left='50%'; toastDiv.style.transform='translateX(-50%)';
  toastDiv.style.background='#111827'; toastDiv.style.color='#fff'; toastDiv.style.padding='10px 14px';
  toastDiv.style.borderRadius='10px'; toastDiv.style.boxShadow='0 6px 20px rgba(0,0,0,.15)'; toastDiv.style.zIndex='9999'; toastDiv.style.display='none';
  document.body.appendChild(toastDiv);
  function toast(msg){ clearTimeout(toastTimer); toastDiv.textContent=msg; toastDiv.style.display='block'; toastTimer=setTimeout(()=>toastDiv.style.display='none',1900); }

  // Click events
  $('#btnRandom').addEventListener('click', randomize);
  $('#btnLock').addEventListener('click', toggleLock);
  $('#btnNew').addEventListener('click', ()=>{ if(confirm('Clear current note?')){ clearAllFields(); autosave(); }});
  $('#btnSave').addEventListener('click', ()=>autosave());
  $('#btnLoad').addEventListener('click', ()=>{ if(!current){ toast('Select and lock a scenario first.'); return;} loadDraft(); });
  $('#btnExport').addEventListener('click', downloadWord);
  $('#btnCopy').addEventListener('click', copyPlain);
  $('#btnCopyScenario').addEventListener('click', copyScenario);
  $('#btnPrint').addEventListener('click', ()=>printPage());
  [F.context,F.design,F.purpose,F.outcomes,F.measures,F.designPlan,F.ethics,F.assumptions].forEach(el=>el.addEventListener('input', ()=>{ updateCounters(); autosave(); }));

  // Keyboard shortcuts (safe): ignore when typing; require Alt
  function isTypingTarget(el){ if(!el) return false; const tag=el.tagName; return tag==='INPUT'||tag==='TEXTAREA'||el.isContentEditable; }
  window.addEventListener('keydown',(e)=>{
    if(isTypingTarget(document.activeElement)||isTypingTarget(e.target)) return;
    if(!e.altKey) return;
    const k=e.key.toLowerCase();
    if(k==='r'){ e.preventDefault(); randomize(); }
    if(k==='l'){ e.preventDefault(); toggleLock(); }
    if(k==='p'){ e.preventDefault(); printPage(); }
    if(k==='e'){ e.preventDefault(); downloadWord(); }
  });

  // Init
  function updateCounters(){ 
    document.getElementById('cntContext').textContent=`${wordCount(document.getElementById('fContext').value)} words`;
    document.getElementById('cntDesign').textContent=`${wordCount(document.getElementById('fDesign').value)} words`;
    document.getElementById('cntPurpose').textContent=`${wordCount(document.getElementById('fPurpose').value)} words`;
    document.getElementById('cntOutcomes').textContent=`${wordCount(document.getElementById('fOutcomes').value)} words`;
    document.getElementById('cntMeasures').textContent=`${wordCount(document.getElementById('fMeasures').value)} words`;
    document.getElementById('cntDesignPlan').textContent=`${wordCount(document.getElementById('fDesignPlan').value)} words`;
    document.getElementById('cntEthics').textContent=`${wordCount(document.getElementById('fEthics').value)} words`;
    const hits=[document.getElementById('fContext'),document.getElementById('fDesign'),document.getElementById('fPurpose'),document.getElementById('fOutcomes'),document.getElementById('fMeasures'),document.getElementById('fDesignPlan'),document.getElementById('fEthics')].filter(x=>wordCount(x.value)>=100).length;
    document.getElementById('progress').textContent=`${hits}/7 sections with 100+ words`;
  }
  updateLockUi(); applyShowIds(); renderCase();
</script>
</body>
</html>
