<!doctype html>
<!-- =========================================================
Repo: elizcurley/ProgramGenerator
File: /index.html
Program Evaluation Generator — single-file, offline, no deps
========================================================= -->
<html lang="en">
<head>
<meta charset="utf-8">
<title>Program Evaluation Generator</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
  :root{
    --bg:#f5f7fb;--bg-2:#ebf2ff;--card:#ffffff;--ink:#0f172a;--muted:#6b7280;--line:#e5e7eb;--accent:#2563eb;
    --ok:#0a7f3f;--warn:#c2410c;--shadow:0 2px 8px rgba(0,0,0,.06),0 12px 40px rgba(0,0,0,.12);
    --header-h: 140px; /* updated by JS */
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial,sans-serif;color:var(--ink);background:radial-gradient(circle at 20% 20%,#f1f5ff 0,#f5f7fb 35%,#f5f7fb 70%,#edf2ff 100%);line-height:1.6}

  /* ===== Header: compact + sticky that shrinks on scroll ===== */
  header{
    position:sticky;top:0;background:rgba(255,255,255,.96);backdrop-filter:blur(6px);
    border-bottom:1px solid var(--line);box-shadow:0 6px 30px rgba(37,99,235,.08);z-index:10;
  }
  .wrap{max-width:1200px;margin:0 auto;padding:18px 16px}
  .titlebar{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}

  /* Compact header */
  .hero{display:flex;flex-direction:column;gap:4px;min-width:220px}
  .eyebrow{font-size:12px;font-weight:700;letter-spacing:.12em;color:var(--accent);text-transform:uppercase}
  .title{font-size:20px;font-weight:800;display:flex;align-items:center;gap:8px}
  .subtitle{display:none}
  .meta{display:none}
  .banner-row{display:none}

  /* Toolbar + buttons */
  .toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:flex-end;min-width:280px}
  button{border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 10px;font:inherit;cursor:pointer;box-shadow:0 1px 0 rgba(0,0,0,.02)}
  button:hover{border-color:#cbd5e1}
  button.primary{background:var(--accent);border-color:var(--accent);color:#fff}
  button.ghost{background:#f8fafc}

  /* Status chip */
  .status{font-size:12px;border:1px solid var(--line);padding:4px 10px;border-radius:999px;background:#fafafa;white-space:nowrap}
  .status.locked{border-color:#cce9d8;background:#f0fdf4;color:var(--ok)}
  .status.unlocked{border-color:#ffe2c7;background:#fff7ed;color:var(--warn)}
  .toolbar .status{order:2;flex-basis:100%;text-align:right}
  @media(min-width:700px){ .toolbar .status{order:0;flex-basis:auto;margin-left:4px} }

  /* Header “compact on scroll” */
  header.compact .wrap{padding:10px 12px}
  header.compact .title{font-size:18px}
  header.compact .eyebrow{display:none}

  /* ===== Layout/cards ===== */
  .layout{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px}
  @media(max-width:1024px){.layout{grid-template-columns:1fr}}

  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;box-shadow:var(--shadow);position:relative;overflow:hidden}
  .card h2{margin:0;padding:16px;border-bottom:1px solid var(--line);font-size:18px}
  .card .body{padding:16px}
  .card::before{content:"";position:absolute;inset:0;background:linear-gradient(120deg,rgba(37,99,235,.06),rgba(37,99,235,.00),rgba(14,165,233,.04));opacity:.6;pointer-events:none}

  .pill{display:inline-flex;align-items:center;gap:6px;font-size:13px;font-weight:700;padding:6px 10px;border-radius:999px;border:1px solid #cbd5e1;background:#f8fafc;color:#0f172a;box-shadow:0 1px 3px rgba(15,23,42,.08)}
  .pill.accent{background:#e0e7ff;border-color:#c7d2fe;color:#1e3a8a}
  .pill.soft{background:#ecfdf3;border-color:#bbf7d0;color:#166534}
  .pill.outline{background:transparent}

  .banner{background:#f8fafc;border:1px dashed #cbd5e1;border-radius:12px;padding:10px 12px;color:#334155;font-size:13px}
  .banner.primary{border-color:#bfdbfe;background:#e0f2fe;color:#0f172a}
  .banner.warn{border-color:#fed7aa;background:#fff7ed;color:#7c2d12}
  .banner.neutral{border-color:#e5e7eb;background:#f8fafc}

  .grid{display:grid;grid-template-columns:240px 1fr;border:1px solid var(--line);border-radius:12px;overflow:hidden}
  .row{display:contents}
  .key{padding:10px 12px;background:#f8fafc;border-bottom:1px solid var(--line);border-right:1px solid var(--line);font-weight:600}
  .val{padding:10px 12px;border-bottom:1px solid var(--line);white-space:pre-wrap}
  .val p{margin:0 0 10px}
  h3{margin:16px 0 8px}
  textarea{width:100%;border:1px solid var(--line);border-radius:10px;padding:10px 12px;background:#fff;font:inherit;min-height:120px;resize:vertical}
  .sidecol{display:flex;flex-direction:column;gap:16px}
  .hr{height:1px;background:var(--line);margin:12px 0}
  .toast{position:fixed;bottom:12px;right:12px;background:#111;color:#fff;padding:10px 12px;border-radius:10px;opacity:0;transform:translateY(8px);transition:.2s;pointer-events:none}
  .toast.show{opacity:1;transform:translateY(0)}

  @media(max-width:900px){
    .titlebar{padding-right:16px}
    .toolbar{justify-content:flex-start}
  }

  @media print{
    header,.toast,.toolbar{display:none !important}
    body{background:#fff}
    .card{box-shadow:none;border-color:#ddd}
    .layout{grid-template-columns:1fr}
  }

  /* ===== Make ONLY the vignette body scroll, page handles the Builder ===== */
  /* Why: keep notes short/natural; prevent long scroll to get past vignette. */
  #scenarioCard .body{
    overflow:auto;
    max-height: calc(100dvh - var(--header-h) - 32px); /* viewport minus header + gap */
  }
  /* Small screens: slightly shorter to leave space */
  @media(max-width:1024px){
    #scenarioCard .body{ max-height: 60vh; }
  }
</style>
</head>
<body>
<header id="siteHeader">
  <div class="wrap titlebar">
    <div class="hero">
      <div class="eyebrow">Program Evaluation Assignment</div>
      <div class="title">Program Evaluation Generator <span class="pill accent">Program Evaluation</span></div>
      <p class="subtitle">Use this generator to craft your plan for the Program Evaluation assignment in SOW5404. If you need the Program Development assignment, open the companion site instead so the prompts match.</p>
      <div class="meta">
        <span class="pill soft">Course: <span id="courseTag">SOW5404 • Spring 2026</span></span>
        <span class="pill outline">Single-file • Offline-ready</span>
        <span class="pill outline">Built-in Word export</span>
      </div>
      <div class="banner-row">
        <div class="banner primary">Editing is enabled only when <strong>Locked</strong>. While locked, a draft autosaves to your browser every few seconds. <em>Always</em> click <strong>Save</strong> before leaving the page.</div>
        <div class="banner neutral">This page is dedicated to the <strong>PROGRAM EVALUATION</strong> assignment. Use the <em>Program Development Generator</em> for the separate development project.</div>
        <div class="banner warn" role="status">Note: When opening an exported Word file you may see an "unreadable content" warning. Click <strong>Yes</strong> to recover and the document will load correctly.</div>
      </div>
    </div>
    <div class="toolbar">
      <button id="btnRandom" title="Randomize scenario (Alt+R)">Randomize</button>
      <button id="btnLock" class="primary" title="Lock or Unlock for writing (Alt+L)">Lock</button>
      <button id="btnNew" class="ghost" title="Clear plan fields">New</button>
      <button id="btnSave" title="Save draft (Ctrl+S / Cmd+S)">Save</button>
      <button id="btnLoad" title="Load saved draft">Load</button>
      <button id="btnCopyScenario" title="Copy scenario details as plain text">Copy Scenario</button>
      <button id="btnCopyAll" title="Copy scenario + plan as plain text">Copy All</button>
      <button id="btnExport" title="Export to Word (.docx) (Alt+E)">Export Word</button>
      <button id="btnPrint" title="Print (Alt+P)">Print</button>
      <span id="statusChip" class="status unlocked">Unlocked</span>
    </div>
  </div>
</header>

<!-- Drawer keeps long guidance out of the header -->
<div class="wrap info-drawer" id="assignmentNotes">
  <details>
    <summary>Assignment details &amp; warnings</summary>
    <p class="subtitle">Use this generator to craft your plan for the Program Evaluation assignment in SOW5404. If you need the Program Development assignment, open the companion site instead so the prompts match.</p>
    <div class="banner-row">
      <div class="banner primary">Editing is enabled only when <strong>Locked</strong>. While locked, a draft autosaves to your browser every few seconds. <em>Always</em> click <strong>Save</strong> before leaving the page.</div>
      <div class="banner neutral">This page is dedicated to the <strong>PROGRAM EVALUATION</strong> assignment. Use the <em>Program Development Generator</em> for the separate development project.</div>
      <div class="banner warn" role="status">Note: When opening an exported Word file you may see an "unreadable content" warning. Click <strong>Yes</strong> to recover and the document will load correctly.</div>
    </div>
  </details>
</div>

<main class="wrap">
  <div class="layout">
    <!-- LEFT: Scenario panel -->
    <div class="sidecol">
      <div class="card" id="scenarioCard">
        <h2>Scenario Panel</h2>
        <div class="body">
          <h3 id="scenarioTitle">No scenario selected</h3>
          <div id="scenarioGrid" class="grid" aria-live="polite"></div>
        </div>
      </div>
    </div>

    <!-- RIGHT: Evaluation Builder (page scrolls, not internal) -->
    <div class="sidecol">
      <div class="card" id="builderCard">
        <h2>Evaluation Builder</h2>
        <div class="body">
          <div style="display:grid;gap:12px">
            <div><label>Scenario Context & Stakeholders</label><textarea id="f_context" disabled></textarea></div>
            <div><label>Your Program or Practice Design</label><textarea id="f_design" disabled></textarea></div>
            <div><label>Evaluation Purpose & Questions</label><textarea id="f_purpose" disabled></textarea></div>
            <div><label>Outcomes (Conceptualization)</label><textarea id="f_outcomes" disabled></textarea></div>
            <div><label>Operationalization & Data Sources</label><textarea id="f_operational" disabled></textarea></div>
            <div><label>Evaluation Design Plan</label><textarea id="f_designplan" disabled></textarea></div>
            <div><label>Ethics, Power, Limitations & Communication</label><textarea id="f_ethics" disabled></textarea></div>
            <div><label>Assumptions (optional)</label><textarea id="f_assumptions" disabled></textarea></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<div id="toast" class="toast" role="status" aria-live="polite" aria-atomic="true"></div>

<script>
/* ======================== CONFIG ======================== */
const CONFIG={ COURSE_TAG:'SOW5404 • Spring 2026', APPKEY_PREFIX:'PE_APP_APPKEY_', DEFAULT_EXPORT_NAME:'Program_Evaluation.docx' };

/* ==================== DATA — SCENARIOS ================== */
/* Full vignettes as previously inserted (unchanged) */
const SCENARIOS=[
  /* Jefferson Middle School */
  { title:"Jefferson Middle School: Discipline, Trust, and a System in Strain",
    setting_snapshot:`Jefferson Middle School serves approximately 700 students in a neighborhood undergoing rapid gentrification. Long-standing Black and Latine families are being priced out, while newer families move in with different expectations, communication styles, and relationships to the school. The building is old, with frequent HVAC failures, limited classroom space, and a rotating roster of substitute teachers. Staff shortages are common, and teacher turnover has increased each year for the last three years.
The school leadership is under pressure from the district to “improve behavioral indicators” after a report showed rising suspension rates. Although the district has encouraged schools to explore alternatives to exclusionary practices, no additional staff or training has been provided. Teachers describe their classrooms as crowded and unpredictable, and the social worker has responsibility for crisis response, attendance concerns, and family outreach with very limited time for prevention or programming.
Families often report feeling disconnected from the school. Some describe feeling unwelcome when raising concerns. Others say they do not understand the discipline process or why certain decisions are made. The school attempts family engagement events, but attendance is inconsistent.`,
    population_snapshot:`The school serves primarily Black and Latine students ages 11 through 14. Many families work multiple jobs, creating challenges for attending meetings or monitoring school communication systems. A significant number of students have recently experienced displacement due to rent increases. Approximately one in six students receives special education services, and many students report varying levels of mistrust toward adults in institutional settings.`,
    core_problems:`There are conflicting beliefs among staff about what the “real problem” is. Some teachers believe that students have become increasingly defiant and that inconsistent classroom management across staff leads to escalation. Others believe that the zero-tolerance disciplinary policies adopted several years ago are producing more harm than good. Families express confusion and frustration about discipline decisions, and some say they feel judged or misunderstood when they reach out for support.
Administrators feel caught between community expectations, district pressure, and staff fatigue. Teachers feel unsupported and fear that loosening disciplinary responses will lead to loss of control in the classroom. Students say they are suspended for relatively small behaviors, and that adults interpret their communication styles as disrespectful. There is no agreement on what should change or who holds responsibility.`,
    stakeholder_glimpses:`Teachers: Want calmer classrooms, feel overwhelmed, and believe discipline must be consistent. Some feel blamed for outcomes they cannot control.
Students: Report feeling targeted, misunderstood, and excluded from decisions affecting them. Fear that suspensions damage their academic futures.
Families: Want transparency and fairness. Some feel intimidated in meetings. Others feel staff do not understand cultural norms or communication differences.
Administrators: Worried about district scrutiny, family complaints, and public perception. Want order but lack resources for systemic change.
District Representatives: Emphasize behavioral metrics tied to school performance. Offer limited guidance or support.
School Social Worker: Overextended and unable to address root causes. Wishes for more collaborative systems but lacks authority to change workflows.`,
    equity_signals:`Racialized discipline patterns, gentrification pressures, inconsistent access to special education services, and limited language-inclusive communication shape the environment. Families with fewer resources often experience greater barriers to advocacy. Tensions between policing in the neighborhood and student safety perceptions affect trust in school authority.`,
    constraints_resources:`Constraints:
• No new full-time positions available
• Limited time from the social worker for non-crisis programming
• Monthly reporting cycles delay data availability
• Limited physical space for group meetings or restorative practices
• Inconsistent definitions of “incidents” across staff
• Strong district pressure to show improvement without providing resources
Resources:
• A committed core of teachers interested in collaboration
• A bilingual family liaison who is well connected to the community
• After-school time with some flexible space
• Student leadership groups willing to provide feedback
• Existing climate surveys conducted annually`,
    role:`You are the MSW evaluator and program designer assigned to develop one small, feasible program or practice initiative, along with an evaluation plan, that fits within these constraints and addresses the tensions described. You must consider the perspectives and needs of all stakeholder groups.`
  },

  /* Harbor House Shelter */
  { title:"Harbor House Shelter: Burnout, Inconsistent Policies, and Community Pressure",
    setting_snapshot:`Harbor House is a year-round urban homelessness shelter that provides overnight beds, daytime services, meals, and case management. The shelter operates out of an aging building with inadequate ventilation, limited storage, and a mix of open sleeping areas and partitioned spaces. Demand for shelter beds has steadily increased over the last five years due to rising housing costs. The shelter is funded through city contracts, private donations, and seasonal grants, each with different reporting expectations.
Staffing is unstable. Many frontline staff are new and receive only brief on-the-job training. Turnover has increased significantly, and remaining staff feel overwhelmed. Tensions arise between long-term employees who value consistency and newer staff who advocate for more flexible rules. Policies around guest conduct, storage of belongings, and incident documentation are inconsistently followed, leading to frustration among both guests and staff.
Community relationships are strained. Neighborhood residents have complained about loitering and safety concerns. The shelter leadership has received pressure from city officials to demonstrate improved outcomes for guests, particularly in transitioning individuals into stable housing, even though the shelter itself does not control housing availability.`,
    population_snapshot:`The shelter primarily serves adults experiencing homelessness, including individuals with chronic health conditions, untreated mental health concerns, limited income, and histories of trauma. Many guests are Black or Latine community members who have faced long-term structural barriers related to employment, housing access, and discrimination. A significant number of guests rely on public transportation and have inconsistent access to phones or documentation.`,
    core_problems:`Staff report feeling exhausted and express confusion about when and how to enforce shelter rules. Some believe consistency is crucial for safety, while others argue rigid rules escalate tension. Guests describe feeling disrespected or punished unpredictably. Case managers note that documentation requirements pull them away from direct support and contribute to delays in connecting guests to housing programs.
Leadership feels torn between satisfying city grant requirements and responding to staff burnout. Community members increasingly demand visible improvements, while guests report feeling surveilled or judged when outside the building. There is no shared agreement on which problems are most urgent.`,
    stakeholder_glimpses:`Frontline Staff: Want clearer policies, more support, and manageable workloads. Feel blamed for guest dissatisfaction.
Guests: Want dignity, predictability, and fairness. Feel their concerns are ignored until they escalate.
Case Managers: Overwhelmed by paperwork, long referral wait times, and limited housing options.
Shelter Leadership: Facing pressure from funders and neighbors, worried about turnover, and uncertain how to prioritize competing demands.
City Officials: Focused on public perception and shelter performance indicators, with limited understanding of day-to-day operations.
Neighborhood Residents: Express concerns about safety and want better communication from the shelter.`,
    equity_signals:`Housing scarcity, racialized patterns of homelessness, barriers to medical and mental health care, policing patterns in the neighborhood, and inequitable access to supportive services all shape the environment. Guests with limited documentation or inconsistent income face additional obstacles.`,
    constraints_resources:`Constraints:
• No additional funding for new full-time staff
• Limited private space for meetings or groups
• High turnover and inconsistent training
• Documentation requirements tied to funding
• Guest conduct policies that are inconsistently enforced
• Limited housing availability regardless of staff effort
Resources:
• Strong volunteer support for meal services
• A small core of experienced staff who value mentoring newer staff
• Partnerships with local clinics and food banks
• A multipurpose room available during daytime hours
• Some flexibility from private donors for pilot projects`,
    role:`You are the MSW evaluator and program designer assigned to develop one small, feasible program or practice initiative, along with an evaluation plan, that fits within the constraints and addresses the tensions described. You must assess stakeholder priorities and propose a plan that considers the realities of shelter operations and community relationships.`
  },

  /* Prairie County Mobile Health Van */
  { title:"Prairie County Mobile Health Van: Access, Weather, and Uneven Reach",
    setting_snapshot:`Prairie County covers a large rural area with scattered towns, long stretches of farmland, and limited public transportation. The county health department operates a mobile health van that travels to different locations on a rotating weekly schedule, offering basic screenings, chronic condition check-ins, immunizations, and referrals to regional hospitals. The van is staffed by a nurse, a part-time behavioral health consultant, and a driver who also handles scheduling and community outreach.
The van’s route is affected by weather, unpaved roads, and seasonal agricultural demands that impact when community members are available. In winter, routes are frequently canceled due to icy roads. In the summer, many families rely on the van because work schedules and childcare make travel to clinics impossible. Staff describe feeling pulled between wanting to increase service reach and feeling limited by logistics. Equipment is aging, and the van’s generator has become unreliable.
The health department faces public pressure after a local newspaper published a story showing wide gaps in who receives services. Some towns see the van every week, while others go three or more weeks without a visit. Leaders acknowledge these inequities but argue that staffing shortages and geographical barriers leave little flexibility.`,
    population_snapshot:`Residents include older adults with mobility limitations, agricultural workers experiencing seasonal injuries, families with low incomes, and Latine communities concentrated in the western part of the county. Many households lack consistent internet or phone service. Some families rely on neighbors to relay information about the van’s schedule. Trust in institutional providers varies, particularly among migrant farmworker communities who have experienced inconsistent care and language access barriers in the past.`,
    core_problems:`Staff disagree on how to prioritize route schedules. Some argue for consistency, while others believe the van should concentrate on areas with the greatest need, even if that means fewer towns receive weekly visits. Residents in remote areas feel overlooked and express frustration that the van visits more populated towns more often. The nurse reports feeling rushed, and the behavioral health consultant expresses concerns about providing meaningful follow-up when appointments are unpredictable.
The health department leadership wants improved community satisfaction metrics but cannot add more vehicles or staff hours. Town councils have begun contacting the department directly to lobby for more frequent visits, creating political pressure that complicates scheduling. No one agrees on which services are most essential for the van to provide.`,
    stakeholder_glimpses:`Nurse: Wants safer work conditions and more predictable schedules. Worries about burnout.
Behavioral Health Consultant: Struggles to build trust without regular visits. Wants time for relationship-based work.
Driver/Outreach Coordinator: Overwhelmed by scheduling requests and community expectations.
Health Department Leadership: Wants to show equitable service delivery but lacks resources.
Town Councils: Advocate for their own communities, sometimes at odds with one another.
Residents: Want access that does not require long travel or time off from work. Some feel they are always last on the list.`,
    equity_signals:`Limited transportation infrastructure, geographic isolation, agricultural labor schedules, historic underinvestment in rural health systems, and language access barriers create inequities in care. Weather patterns disproportionately affect remote areas, amplifying disparities in service availability.`,
    constraints_resources:`Constraints:
• Only one van and no budget for a second
• Unreliable generator
• Seasonal weather disruptions
• Limited staff capacity
• Strong political pressure from multiple towns
• Poor cellular and internet coverage in many communities
Resources:
• Strong trust between staff and several community leaders
• Local libraries willing to host services
• Volunteer drivers occasionally available during busy seasons
• A county-wide health needs assessment completed last year`,
    role:`You are the MSW evaluator and program designer asked to create one feasible program or practice initiative and an evaluation plan that addresses the tensions described. Your design must work within current staffing levels and account for geographic, seasonal, and political barriers.`
  },

  /* Riverbend Aging Resource Center */
  { title:"Riverbend Aging Resource Center: Isolation, Technology, and Uneven Access",
    setting_snapshot:`The Riverbend Aging Resource Center is a county-supported hub that provides information, referrals, caregiver support groups, and social programming for older adults. In response to a new state mandate encouraging digital literacy and virtual engagement for older adults, Riverbend has been asked to expand technology-based services. These include virtual appointments, online caregiver workshops, tablet lending, and digital navigation sessions.
However, the center is housed in an older municipal building with limited accessible space. Staff are already balancing a large volume of walk-in requests, crisis calls, and paperwork for state reporting. Many older adults arrive unscheduled, often seeking immediate help with housing issues, benefits applications, or transportation needs. Staff feel torn between responding to crises and launching the new digital initiatives.`,
    population_snapshot:`Riverbend serves a diverse group of older adults. Many live alone, rely on fixed incomes, and have mobility limitations. A significant number are Black and Latine elders with long histories in the neighborhood but limited access to high-speed internet. Some older adults rely on adult children or neighbors for transportation. Others are recent retirees with higher incomes who expect modern, personalized programming. There are also older adults with cognitive impairments who require additional support.`,
    core_problems:`Staff feel unprepared to provide digital navigation services and worry that technology-based programs will exclude the very people who need the most support. Leadership emphasizes that failure to implement the mandate may jeopardize funding. Some older adults say they feel embarrassed asking technology questions and prefer in-person support. Others are enthusiastic but frustrated by long wait times and confusing instructions.
Caregivers report that virtual workshops would help them participate despite work schedules, but only if the center can reliably provide support and troubleshoot access issues. The center’s phone system cannot handle the volume of calls during peak hours, and staff express concern about increasing virtual services without improving communication tools.`,
    stakeholder_glimpses:`Front Desk Staff: Feel overwhelmed triaging walk-ins and calls. Worry that new programs will increase workload.
Program Coordinators: Interested in innovation but uncertain how to measure success.
Older Adults: Varied needs. Some excited about technology, others anxious or excluded due to physical, cognitive, or financial barriers.
Caregivers: Want reliable virtual options to reduce burden.
County Leadership: Focused on compliance with the state mandate and funding preservation.
State Agencies: Require digital literacy rollout but offer only minimal training or funding.`,
    equity_signals:`Digital divides based on income, race, geography, and disability shape access. Older adults with limited English proficiency face additional barriers. Structural ageism influences how quickly systems invest in or deprioritize elder services. Transportation barriers and housing instability further isolate older adults.`,
    constraints_resources:`Constraints:
• No additional staff positions
• Outdated phone system
• Limited accessible space for in-person workshops
• Wide variation in digital literacy among older adults
• Strict state expectations for reporting outcomes
• Long-standing walk-in demand that cannot be reduced
Resources:
• Strong relationships with local libraries
• A volunteer corps of retired adults with varied skills
• A small technology training grant available for short-term pilots
• Caregiver support networks eager to participate in virtual offerings`,
    role:`You are the MSW evaluator and program designer assigned to develop one feasible program or practice initiative, along with an evaluation plan, that responds to the tensions described. You must propose an approach that respects the diversity of older adults’ needs while working within the center’s constraints.`
  },

  /* Lakewood Lead Pipe Replacement */
  { title:"Lakewood Lead Pipe Replacement: Timelines, Transparency, and Uneven Trust",
    setting_snapshot:`The City of Lakewood launched a multi-year initiative to replace lead service lines after state-level scrutiny revealed that several neighborhoods had elevated lead levels in tap water. Although the city committed to full replacement, the rollout has been uneven. More affluent neighborhoods were upgraded first because of easier pipe access and fewer infrastructure complications, while older, predominantly Black and Latine neighborhoods face delays attributed to “complexity,” “staffing shortages,” and “permitting challenges.”
Information about the timeline has been inconsistent. Public meetings are held, but many residents work during those hours or do not learn about the meetings until after they occur. A city-run website publishes updates, but many households in older neighborhoods have limited internet access or rely on mobile devices with limited data. Construction crews appear without notice, leaving residents confused about when water will be shut off or when yards will be disturbed. In some areas, repairs have been left unfinished for weeks.
Community frustration has grown. Several local organizations have demanded clearer communication, equitable prioritization, and accessible channels for reporting concerns. City leadership insists the process is fair and that “technical needs drive the schedule,” although internal emails (circulated publicly) show disagreements among departments.`,
    population_snapshot:`The affected neighborhoods include long-standing Black families, multigenerational Latine households, immigrant families with varying English proficiency, families with young children, and older adults living on fixed incomes. Many residents rely on bottled water, which strains budgets. Several homes have outdated plumbing that complicates replacement and increases anxiety about property damage. Some households rent from absentee landlords who are difficult to reach.`,
    core_problems:`Residents do not trust the explanations offered for delays. Neighborhood associations argue that resource scarcity is being used to justify inequitable timelines. City engineers claim older neighborhoods require specialized contractors. Communication staff express difficulty producing clear, multilingual updates when construction timelines change daily. Advocacy groups allege that the city’s public communication privileges residents with stable internet and free time to attend meetings.
City workers report harassment from frustrated residents and feel caught between community anger and leadership expectations. Meanwhile, the mayor’s office pushes departments to demonstrate progress before the next election cycle, which adds political pressure that complicates transparency.`,
    stakeholder_glimpses:`Residents: Want predictable schedules, honest explanations, and assurance that their neighborhoods are not being deprioritized.
Community Organizations: Push for equitable timelines and culturally responsive communication.
City Engineers: Cite technical barriers and contractor shortages.
Public Communication Staff: Struggle to meet demands for accessible updates.
Mayor’s Office: Focused on public perception, equity narratives, and election implications.
Landlords: Often unresponsive to outreach, complicating permissions needed for pipe access.
Environmental Health Advocates: Emphasize long-term health risks and accountability.`,
    equity_signals:`The neighborhoods experiencing the longest delays have historically faced disinvestment, discriminatory housing practices, and environmental burdens. Language barriers limit access to public information. Renters lack control over household infrastructure. Digital access disparities prevent many from engaging with online updates. The burden of bottled water falls disproportionately on low-income households.`,
    constraints_resources:`Constraints:
• No possibility of adding new contractors within the current budget
• Complex underground infrastructure in older neighborhoods
• City’s communication staff already overstretched
• Water shutoffs must be minimized to remain compliant with state guidelines
• Construction timelines frequently shift due to permitting or weather
• High levels of public distrust
Resources:
• Neighborhood ambassadors who already distribute information for other city programs
• Community centers willing to host meetings at flexible times
• Existing water testing data collected by the health department
• Strong advocacy groups capable of mobilizing residents for feedback sessions`,
    role:`You are the MSW evaluator and program designer tasked with creating one small, feasible program or practice initiative and an evaluation plan that helps improve equity, transparency, or communication in the lead pipe replacement process. You must design within the city’s financial and staffing constraints and address the needs of multiple stakeholder groups.`
  },

  /* Turning Point House */
  { title:"Turning Point House: Reentry, Safety, and Autonomy in Tension",
    setting_snapshot:`Turning Point House is a transitional housing program for adults returning from incarceration. The facility houses up to twenty residents in shared rooms and provides case management, employment workshops, and limited mental health support. The building is located in a mixed residential neighborhood that has historically pushed back against programs supporting people with criminal records. Several neighbors have recently complained about noise, unfamiliar visitors, and “safety concerns,” prompting a formal meeting with the city council.
Inside the program, staff are divided over how to maintain safety without replicating the restrictive conditions residents just left. Some staff prefer structured schedules and curfews, while others want a more autonomy-supportive environment. Residents express frustration that rules feel unpredictable or unevenly enforced. For example, some report that staff confront them for minor infractions while ignoring more serious concerns raised by residents.
The program operates under a contract requiring regular reporting to the local criminal justice oversight board. Leadership is under pressure to demonstrate positive outcomes, especially reductions in rearrest rates. Staff note that meaningful reentry progress is often slow, relational, and nonlinear, which conflicts with the reporting expectations.`,
    population_snapshot:`Residents are adults recently released from incarceration, primarily Black and Latine men with histories of unstable housing, employment barriers, trauma exposure, chronic health conditions, and strained family connections. Some struggle with substance use or untreated mental health challenges. Many hold legitimate fear of returning to the prison system and feel that missteps may jeopardize their freedom.`,
    core_problems:`Residents want independence, respect, and a chance to rebuild their lives without constant scrutiny. Staff want predictability and safety but disagree about the right balance. Leadership wants data that satisfies funders, while neighbors want reassurance that the program will not disrupt the community. Case managers say they have too many administrative tasks to provide meaningful support. Residents say they feel unheard and fear retaliation for speaking up.
Conflicts arise around room checks, curfew enforcement, visitation rules, and expectations for job search documentation. When tensions escalate, staff feel unsupported, and residents feel punished. No shared philosophy of reentry is guiding daily practices.`,
    stakeholder_glimpses:`Residents: Want autonomy, consistent rules, and support in finding housing and jobs.
Frontline Staff: Divided on structure versus flexibility. Feel pressure to maintain order.
Case Managers: Overextended and struggling to balance paperwork with relational work.
Program Leadership: Focused on meeting contract expectations and avoiding negative publicity.
Oversight Board: Wants measurable outcomes but provides little guidance.
Neighbors: Concerned about safety and community image.
Local Employers: Sometimes willing to hire residents but inconsistent in follow through.`,
    equity_signals:`Residents face the compounded disadvantages of racialized incarceration patterns, housing discrimination, and employment barriers. Surveillance extends into community settings under reentry supervision. Neighborhood stigma reinforces exclusion. Lack of affordable housing limits residents’ ability to exit the program.`,
    constraints_resources:`Constraints:
• No additional staff positions
• Contractually required data reporting
• Limited physical space for private meetings
• Curfew rules mandated by the oversight board
• Neighborhood tensions affecting program operations
• Residents sharing rooms with little privacy
Resources:
• Partnerships with a few willing employers
• A community volunteer group offering mentorship
• A faith-based organization willing to host workshops
• Resident council meetings already happening monthly
• Staff who are passionate about reentry but need guidance`,
    role:`You are the MSW evaluator and program designer assigned to develop one small, feasible program or practice initiative and an evaluation plan that addresses the tensions described. Your design must balance autonomy, safety, community relationships, and resident voice within existing staffing and contractual constraints.`
  },

  /* Maple Lane Visitation Center */
  { title:"Maple Lane Visitation Center: Quality, Consistency, and Family Dissatisfaction",
    setting_snapshot:`The Maple Lane Visitation Center is a child welfare–contracted site where parents participate in supervised or semi-supervised visits with their children who are placed in foster care. The center consists of four small visitation rooms, a shared playroom, and an administrative space that also functions as the staff kitchen. Toys and supplies are frequently mismatched, outdated, or missing pieces. Staffing varies from day to day, with a combination of full-time supervisors, part-time aides, and rotating interns.
Caseworkers from the county agency schedule visits, but the center itself is responsible for carrying them out and documenting interactions. Scheduling is chaotic, with last-minute cancellations and inconsistent communication between the county and the center. Some visits overlap in ways that strain the facility’s limited space. The center director is under pressure to reduce complaints and improve family satisfaction scores after a recent audit highlighted concerns about inconsistent supervision, unclear expectations, and uneven quality in visit documentation.
Families often arrive stressed, having traveled long distances using unreliable transportation. Some experience long waits due to miscommunication or staff turnover. Staff describe feeling overwhelmed by the emotional intensity of the visits and the need to enforce rules that they sometimes feel are unclear or unfair.`,
    population_snapshot:`Families come from diverse racial and socioeconomic backgrounds, with many parents facing housing instability, employment challenges, and limited access to transportation. A significant number of families are Black or Latine and report prior negative experiences with child welfare agencies. Many children placed in foster care are adjusting to new environments, and some have trauma histories that affect their behavior during visits. Parents may be coping with grief, shame, or fear, while also navigating complex court requirements.`,
    core_problems:`Staff disagree about what high-quality supervision should look like. Some believe supervisors should intervene frequently to ensure safety and compliance with case plans. Others argue that constant intervention undermines parent-child bonding and creates an atmosphere of surveillance. Parents report feeling judged and say they often do not know what is expected of them during visits. Some children become distressed by the structured nature of the setting.
County caseworkers express frustration with inconsistent documentation from the center, which complicates court reporting. Staff at the center feel unsupported by the county, which they describe as unresponsive and unclear in expectations. The small physical layout limits privacy and makes emotionally charged moments difficult to manage. There is no shared understanding of how to balance safety, family autonomy, emotional support, and reporting requirements.`,
    stakeholder_glimpses:`Parents: Want clear expectations, dignity, and consistent supervision. Many feel scrutinized or misunderstood.
Children: Want time with parents in a calm, predictable environment; may struggle with transitions.
Visitation Supervisors: Feel overwhelmed, worry about safety, and lack consistent guidance.
Interns/Aides: Have minimal training and inconsistent handoff procedures.
County Caseworkers: Want reliable documentation and fewer disruptions in scheduling.
Center Leadership: Pressured to reduce complaints and improve documentation quality without additional resources.
Foster Parents: Want clearer communication about visit timing, transitions, and behavioral support needs.`,
    equity_signals:`Families from historically marginalized communities experience disproportionate child welfare involvement. Transportation barriers make attendance difficult. Cultural misunderstandings shape perceptions of communication and parenting styles. Limited financial resources contribute to instability that is interpreted through a deficit-oriented lens. System power dynamics influence how parents feel judged or supported.`,
    constraints_resources:`Constraints:
• No capacity to hire additional supervisors
• Limited physical space and inconsistent room availability
• Unpredictable communication from the county
• Mandatory documentation expectations set by the court
• High emotional intensity affecting both staff and families
• Outdated or insufficient play materials
Resources:
• A committed core of long-term supervisors familiar with families
• A flexible playroom that can be reorganized
• Community volunteers available for cleaning and toy repairs
• A strong new center director open to program adjustments
• Access to some county-level data on visit frequency and attendance`,
    role:`You are the MSW evaluator and program designer assigned to create one small, feasible program or practice initiative, along with an evaluation plan, that supports improved consistency, quality, or family engagement in visitation services. Your design must respect family dignity and work within the center’s staffing and structural constraints.`
  },

  /* SafeLine Shelter Hotline */
  { title:"SafeLine Shelter Hotline: Surging Calls, Limited Staff, and Ethical Triage",
    setting_snapshot:`SafeLine is a domestic violence shelter that operates a twenty-four-hour hotline for crisis support, safety planning, and intake into emergency shelter beds. The hotline is staffed by a mix of paid advocates and trained volunteers. Calls have increased steadily over the past two years, particularly in the evenings when staffing is lowest. Shelter beds fill quickly, leading to long waitlists and difficult conversations with callers seeking immediate safety.
Advocates report receiving calls that range from brief information requests to complex, high-risk situations requiring extended time on the phone. Phone lines sometimes ring unanswered when staff are already handling multiple calls. Volunteers want to support callers but feel uncertain when situations escalate. The shelter director recently received feedback from community partners that some clients experience long wait times or abrupt call endings, raising concerns about quality and consistency.
The shelter has strict confidentiality guidelines, and advocates cannot request identifying details unless the caller chooses to disclose them. This can make safety assessment challenging. The director is under pressure to demonstrate responsiveness to funders while also protecting staff well-being in an emotionally demanding environment.`,
    population_snapshot:`Callers include survivors of intimate partner violence, friends or family members seeking support, survivors who have left but remain unsafe, individuals who are unsure if their situation qualifies as abuse, and sometimes people in acute crisis who may also be navigating mental health concerns, substance use, or homelessness. Many callers are women, but a significant number are men, gender-diverse adults, and teens. Some callers speak languages not represented among available staff or volunteers.`,
    core_problems:`Advocates feel torn between spending enough time with each caller and ensuring that others do not wait too long. Some believe the hotline should prioritize crisis calls only, while others argue that emotional support is also essential and can prevent escalation. Volunteers feel unprepared for high-risk cases and want clearer boundaries. Staff burnout is high, and some advocates describe feeling emotionally numb at the end of their shift.
Callers have different needs and expectations. Some need immediate shelter placement. Others need safety planning, validation, or guidance about legal options. The shelter’s limited bed capacity means that many callers must be referred elsewhere, which can feel devastating for survivors who built the courage to reach out. Language access gaps result in delayed or incomplete support for multilingual callers.`,
    stakeholder_glimpses:`Hotline Advocates: Want manageable workloads, clearer protocols, and emotional support.
Volunteers: Want additional training and clearer guidance for crisis situations.
Shelter Director: Balancing funder expectations, service quality, staff well-being, and public perception.
Survivors/Callers: Need safety, validation, and predictable support. Many fear calling again if the experience feels dismissive or confusing.
Community Partners: Want reliable referrals and consistent communication.
Funders: Focused on quantifiable outcomes such as call volume, wait times, and shelter placements.`,
    equity_signals:`Survivors face systemic barriers including housing scarcity, financial dependence, policing responses shaped by racial bias, language access inequities, and limited disability-accessible shelter options. Hotline support is influenced by structural inequities that shape who has privacy to call, who feels safe reaching out, and who is understood by staff.`,
    constraints_resources:`Constraints:
• No additional full-time staff capacity
• Limited shelter beds and unpredictable turnover
• Volunteers with varying skill levels
• Mandatory adherence to confidentiality guidelines
• Surging call volume with peak hours understaffed
• Inconsistent language access
Resources:
• A strong training curriculum for new volunteers
• Advocates committed to survivor-centered support
• Partnerships with neighboring shelters
• A small discretionary fund for short-term safety needs
• Previous internal reports on call patterns and peak hours`,
    role:`You are the MSW evaluator and program designer assigned to develop a small, feasible program or practice initiative, along with an evaluation plan, that strengthens hotline accessibility, safety, or consistency. You must design within existing staffing and bed capacity constraints.`
  },

  /* Harborview Community Violence Prevention Network */
  { title:"Harborview Community Violence Prevention Network: Funding Shifts, Community Trust, and Conflicting Visions",
    setting_snapshot:`Harborview is a midsized city that has experienced a rise in youth-involved shootings over the past three years. In response, the city council renewed a grant for the Harborview Community Violence Prevention Network, a coalition of grassroots groups, youth mentors, street outreach workers, and a small administrative team housed within a neighborhood nonprofit. The network provides conflict mediation, mentorship, community events, and supports youth who have experienced violence or are at heightened risk.
The city recently changed its funding priorities, requiring programs to demonstrate short-term, quantifiable reductions in violent incidents. This shift has unsettled the coalition. Some groups rely on longer-term relationship-building methods that do not produce quick returns. Others welcome the emphasis on metrics but disagree about what should be measured and how. The coalition has no unified approach to data collection, and member organizations interpret “success” differently.
Neighborhood trust varies. Some residents view the network as a critical lifeline, while others distrust any program associated with the city. Leaders of the coalition report that some youth fear retaliation for participating openly in programming, while others attend inconsistently due to school suspensions, family responsibilities, or unstable housing.`,
    population_snapshot:`The network serves youth and young adults ages 14 through 25, many of whom are Black or Latine, have experienced school exclusion, are unstably housed, or have lost friends or family members to violence. Some youth have ongoing involvement with probation or diversion programs. Families often navigate financial strain, community trauma, and limited access to mental health care. Grassroots organizations in the coalition represent different cultural, linguistic, and neighborhood identities.`,
    core_problems:`Coalition members disagree on how to adapt to the city’s revised expectations. Longer-standing grassroots organizations believe the shift toward short-term metrics ignores the realities of violence prevention, which depends on trust, consistent presence, and long-term relational work. Newer groups are more open to data collection but want support and clarity.
Youth participants report mixed experiences. Some feel deeply supported by outreach workers, while others say programs are inconsistent, disorganized, or disconnected from their actual needs. Street outreach workers feel pressure to be constantly available, but burnout and safety concerns limit their capacity.
The city wants “evidence of impact” but has not provided guidance on what counts as an outcome. Coalition leadership feels squeezed between funder expectations, youth realities, and internal conflicts about program identity.`,
    stakeholder_glimpses:`Youth Participants: Want consistent mentors, safe spaces, and opportunities that feel relevant to their lives. Feel frustrated when programming changes without explanation.
Street Outreach Workers: Carry emotional burdens, work unpredictable hours, and fear that increased policing damages trust with youth.
Grassroots Organizations: Value cultural grounding and autonomy, but feel overshadowed by city demands.
Coalition Leadership: Struggling to maintain cohesion, comply with reporting expectations, and balance different philosophies of prevention.
City Officials: Focused on measurable reductions in violence and accountability to the public.
Residents: Desire safety but worry about program transparency and sustainability.
Local Schools: Hope the coalition can reduce conflict spillover onto campuses, but communication is inconsistent.`,
    equity_signals:`Racialized policing, neighborhood disinvestment, trauma exposure, school exclusion, limited mental health access, and economic inequality shape youth pathways into and out of violence. Long histories of broken institutional promises fuel community mistrust. Funding tied to specific metrics may amplify inequities by prioritizing easily countable outcomes over relational, culturally grounded work.`,
    constraints_resources:`Constraints:
• Funding tied to short-term metrics
• Coalition conflict over program direction
• Limited staff capacity and burnout
• Safety concerns for outreach workers
• Inconsistent youth attendance
• No shared data collection framework
Resources:
• Deep trust between some outreach workers and youth
• Strong cultural roots in member organizations
• Community spaces available for programming
• A dedicated coalition coordinator willing to experiment
• Youth leaders eager to contribute ideas`,
    role:`You are the MSW evaluator and program designer asked to create one feasible program or practice initiative and an evaluation plan that can strengthen cohesion, clarify outcomes, or improve the usefulness and equity of data collection. You must account for the conflicting philosophies of prevention, varied stakeholder expectations, and structural realities youth face.`
  },

  /* Prism Youth Collective */
  { title:"Prism Youth Collective: Safety, Identity, and Community Backlash",
    setting_snapshot:`The Prism Youth Collective is an after-school program serving LGBTQ youth ages 12 through 18. It operates out of a community center that also hosts sports programs, senior activities, and public meetings. The program offers drop-in hours, peer support groups, creative arts workshops, and occasional family engagement events. Staff consist of two youth workers, a part-time coordinator, and volunteers who assist with activities.
During the past year, the program experienced heightened community scrutiny following a series of heated school board meetings and public commentary questioning the legitimacy of LGBTQ-focused youth services. Some volunteers withdrew due to fear of backlash. The community center director received complaints from residents claiming the program was “divisive,” while others expressed concerns about youth privacy and safety. As a result, the center now requires additional documentation for room reservations and approval for public-facing events.
Increased scrutiny has affected youth as well. Some young people feel anxious entering the building, worried about who might see them. Others express frustration that programs they love are being scaled back or delayed due to new administrative hurdles. Staff want to maintain a safe, affirming space but feel uncertain how to balance youth visibility with protection from harassment.`,
    population_snapshot:`Youth participants are diverse in racial, cultural, and socioeconomic backgrounds. Many face family rejection, bullying at school, or mental health challenges such as anxiety and depression. Some youth are exploring their identities privately and rely on the program as their only affirming environment. Others are fully out and active in local advocacy efforts. Several youth experience unstable housing or do not have reliable transportation to the center.`,
    core_problems:`Staff feel overwhelmed by increased administrative requirements that limit flexibility and reduce spontaneity in programming. Some youth want the program to be more visible and activist-oriented, while others prefer privacy and low-profile gatherings. Parents who support the program are divided about whether the center should push back against restrictions or focus on safety and sustainability.
Community center leadership wants to avoid controversy and preserve funding for all programs, but this stance can feel dismissive to staff and youth who are directly targeted by backlash. Local elected officials have offered conflicting statements, further complicating communication. Volunteers feel hesitant to host events without clearer guidance on safety protocols.`,
    stakeholder_glimpses:`Youth Participants: Seek safety, affirmation, and control over visibility. Have varying comfort levels with public events.
Program Staff: Want clarity, emotional support, and tools to protect youth safety without shutting down programming.
Parents/Caregivers: Supportive but divided on strategy and concerned about privacy.
Community Center Leadership: Focused on liability, facility neutrality, and appeasing multiple community groups.
Residents: Some supportive; others skeptical or hostile toward LGBTQ youth programming.
Local Advocates: Want to defend the program publicly but risk intensifying backlash.
Volunteers: Passionate but unsure how to navigate the current climate.`,
    equity_signals:`Youth face discrimination, bullying, and mental health disparities rooted in systemic homophobia and transphobia. Public institutions struggle to support LGBTQ youth equitably within contentious political climates. Safety concerns intersect with race, class, and visibility. Transportation barriers and unstable housing reduce access to affirming spaces.`,
    constraints_resources:`Constraints:
• Additional administrative approvals for events
• Limited staff capacity
• Volunteer uncertainty about safety
• Heightened community scrutiny
• Youth needing variable levels of privacy
• Limited transportation options for some participants
Resources:
• Strong relationships between youth and staff
• A supportive network of local LGBTQ adults who want to mentor
• Access to multipurpose rooms after regular hours
• Partnerships with mental health providers who can consult
• Youth leadership council eager to help shape programming`,
    role:`You are the MSW evaluator and program designer tasked with creating one feasible program or practice initiative and an evaluation plan that enhances safety, accessibility, or youth empowerment while navigating constraints related to backlash, visibility, and administrative requirements.`
  }
];

/* =============== HELPERS =============== */
function $(id){return document.getElementById(id)}
function escapeHTML(s=''){return s.replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]))}
function normalizeDashes(s=''){return s.replace(/[\u2013\u2014]/g,'-')}
function stripEmojis(s=''){return s.replace(/[\p{Extended_Pictographic}\uFE0F]/gu,'')}
function paragraphsHTML(text=''){
  let t=text.replace(/\r\n/g,'\n'); t=normalizeDashes(t); t=stripEmojis(t);
  return t.split(/\n\s*\n/g).map(p=>`<p>${escapeHTML(p).replace(/\n/g,'<br>')}</p>`).join('')
}
function toast(msg){const el=$('toast');el.textContent=msg;el.classList.add('show');setTimeout(()=>el.classList.remove('show'),1200)}
function nowISO(){return new Date().toISOString()}
function activeIsTyping(){const ae=document.activeElement; if(!ae) return false; const tag=ae.tagName.toLowerCase(); return tag==='textarea'||tag==='input'||ae.isContentEditable}

/* clipboard fallback */
async function copyTextSafe(txt){
  try{
    if(navigator.clipboard && window.isSecureContext!==false){
      await navigator.clipboard.writeText(txt);
      return true;
    }
  }catch(_){}
  const ta=document.createElement('textarea');
  ta.value=txt; ta.style.position='fixed'; ta.style.opacity='0';
  document.body.appendChild(ta); ta.focus(); ta.select();
  let ok=false; try{ ok=document.execCommand('copy'); }catch(_){}
  ta.remove(); return ok;
}

/* simple hash */
function hashString(s){ let h=5381; for(let i=0;i<s.length;i++){ h=((h<<5)+h) ^ s.charCodeAt(i); } return (h>>>0).toString(36); }

/* =============== STATE =============== */
let locked=false, currentScenario=null, autosaveTimer=null, lastSavedHash='';

/* =============== INIT =============== */
document.addEventListener('DOMContentLoaded',()=>{
  $('courseTag').textContent=CONFIG.COURSE_TAG;
  bind('btnRandom', onRandomize); bind('btnLock', onLockToggle); bind('btnNew', onNew);
  bind('btnSave', onSave); bind('btnLoad', onLoad);
  bind('btnCopyScenario', onCopyScenario); bind('btnCopyAll', onCopyAll);
  bind('btnExport', onExport); bind('btnPrint', ()=>window.print());

  document.addEventListener('keydown', e=>{
    const modS=(e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='s'; if(modS){e.preventDefault();onSave();return;}
    if(activeIsTyping()) return;
    if(e.altKey&&/r/i.test(e.key)){e.preventDefault();onRandomize();}
    if(e.altKey&&/l/i.test(e.key)){e.preventDefault();onLockToggle();}
    if(e.altKey&&/e/i.test(e.key)){e.preventDefault();onExport();}
    if(e.altKey&&/p/i.test(e.key)){e.preventDefault();window.print();}
  });

  /* Compact header on scroll */
  const hdr=document.getElementById('siteHeader');
  const onScroll=()=>{ if(window.scrollY>8){hdr.classList.add('compact')} else {hdr.classList.remove('compact')} };
  onScroll();
  window.addEventListener('scroll', onScroll, {passive:true});

  /* Compute actual header height for vignette max-height calc */
  function updateHeaderHeightVar(){
    const h = hdr?.offsetHeight || 140;
    document.documentElement.style.setProperty('--header-h', `${h}px`);
  }
  updateHeaderHeightVar();
  window.addEventListener('resize', updateHeaderHeightVar);
});

function bind(id,fn){const el=$(id); if(el) el.addEventListener('click',fn)}

/* =============== RANDOMIZE / RENDER =============== */
function onRandomize(){
  if(!SCENARIOS||!SCENARIOS.length){toast('No scenarios available');return;}
  const idx=Math.floor(Math.random()*SCENARIOS.length);
  currentScenario=SCENARIOS[idx];
  renderScenario(currentScenario);
  clearBuilder();
  lastSavedHash='';
  toast('Scenario selected');
}
function renderScenario(s){
  $('scenarioTitle').textContent=s?.title||'Untitled';
  const grid=$('scenarioGrid'); grid.innerHTML='';
  const map={
    'Setting Snapshot':s.setting_snapshot,
    'Population Snapshot':s.population_snapshot,
    'Core Problems or Tensions':s.core_problems,
    'Stakeholder Glimpses':s.stakeholder_glimpses,
    'Structural and Equity Signals':s.equity_signals,
    'Known Constraints and Resources':s.constraints_resources,
    'Your Role':s.role
  };
  for(const k in map){
    grid.insertAdjacentHTML('beforeend',
      `<div class="row"><div class="key">${escapeHTML(k)}</div><div class="val">${paragraphsHTML(map[k]||'')}</div></div>`
    );
  }
}

/* =============== LOCK / AUTOSAVE =============== */
function setLocked(v){
  locked=v;
  [...document.querySelectorAll('textarea')].forEach(f=>f.disabled=!locked);
  $('btnLock').textContent=locked?'Unlock':'Lock';
  const chip=$('statusChip'); chip.textContent=locked?'Locked for writing':'Unlocked';
  chip.classList.toggle('locked',locked); chip.classList.toggle('unlocked',!locked);
  if(locked){startAutosave()} else {stopAutosave()}
  lastSavedHash='';
}
function onLockToggle(){ if(!currentScenario){toast('Randomize a scenario first');return;} setLocked(!locked) }
function startAutosave(){ stopAutosave(); autosaveTimer=setInterval(onSave,4000) }
function stopAutosave(){ if(autosaveTimer){clearInterval(autosaveTimer); autosaveTimer=null} }

/* =============== BUILDER =============== */
function clearBuilder(){
  ['f_context','f_design','f_purpose','f_outcomes','f_operational','f_designplan','f_ethics','f_assumptions']
    .forEach(id=>$(id).value='');
}

/* =============== SAVE / LOAD =============== */
function storageKey(){const title=(currentScenario?.title||'UNTITLED').slice(0,50); return CONFIG.APPKEY_PREFIX+title}
function collectData(){
  const fields={
    context:$('f_context').value,
    design:$('f_design').value,
    purpose:$('f_purpose').value,
    outcomes:$('f_outcomes').value,
    operational:$('f_operational').value,
    designplan:$('f_designplan').value,
    ethics:$('f_ethics').value,
    assumptions:$('f_assumptions').value
  };
  return {caseTitle:currentScenario?.title||'', fields, timestamp:nowISO()}
}
function onSave(){ if(!currentScenario){toast('Nothing to save');return;}
  try{
    const payload = JSON.stringify(collectData());
    const h = hashString(payload);
    if(h===lastSavedHash){ return; }
    localStorage.setItem(storageKey(), payload);
    lastSavedHash = h;
    toast('Saved');
  }catch(e){console.error(e);toast('Save failed')}
}
function onLoad(){ if(!currentScenario){toast('Randomize a scenario first');return;}
  const raw=localStorage.getItem(storageKey()); if(!raw){toast('No saved draft');return;}
  try{
    const d=JSON.parse(raw);
    $('f_context').value=d.fields?.context||'';
    $('f_design').value=d.fields?.design||'';
    $('f_purpose').value=d.fields?.purpose||'';
    $('f_outcomes').value=d.fields?.outcomes||'';
    $('f_operational').value=d.fields?.operational||'';
    $('f_designplan').value=d.fields?.designplan||'';
    $('f_ethics').value=d.fields?.ethics||'';
    $('f_assumptions').value=d.fields?.assumptions||'';
    toast('Loaded');
    lastSavedHash='';
  }catch(e){console.error(e);toast('Load failed')}
}

/* =============== COPY / EXPORT =============== */
function plainScenarioText(){
  if(!currentScenario) return 'No scenario selected.';
  const s=currentScenario;
  const kv=[
    ['Title',s.title],['Setting Snapshot',s.setting_snapshot],['Population Snapshot',s.population_snapshot],
    ['Core Problems or Tensions',s.core_problems],['Stakeholder Glimpses',s.stakeholder_glimpses],
    ['Structural and Equity Signals',s.equity_signals],['Known Constraints and Resources',s.constraints_resources],['Your Role',s.role]
  ];
  return kv.map(([k,v])=>`${k}:\n${normalizeDashes(stripEmojis(v||''))}`).join('\n\n')
}
function plainAllText(){
  const d=collectData();
  return `${plainScenarioText()}

Scenario Context & Stakeholders:
${d.fields.context}

Your Program or Practice Design:
${d.fields.design}

Evaluation Purpose & Questions:
${d.fields.purpose}

Outcomes (Conceptualization):
${d.fields.outcomes}

Operationalization & Data Sources:
${d.fields.operational}

Evaluation Design Plan:
${d.fields.designplan}

Ethics, Power, Limitations & Communication:
${d.fields.ethics}

Assumptions:
${d.fields.assumptions}

Saved: ${d.timestamp}`
}
async function onCopyScenario(){
  const ok = await copyTextSafe(plainScenarioText());
  toast(ok?'Scenario copied':'Copy failed');
}
async function onCopyAll(){
  const ok = await copyTextSafe(plainAllText());
  toast(ok?'All copied':'Copy failed');
}

function onExport(){
  if(!currentScenario){toast('Randomize a scenario first');return;}
  const d=collectData(), s=currentScenario;
  const gridHTML=`<table border="1" cellpadding="6" cellspacing="0" style="border-collapse:collapse;width:100%">
    ${Object.entries({
      'Setting Snapshot':s.setting_snapshot,
      'Population Snapshot':s.population_snapshot,
      'Core Problems or Tensions':s.core_problems,
      'Stakeholder Glimpses':s.stakeholder_glimpses,
      'Structural and Equity Signals':s.equity_signals,
      'Known Constraints and Resources':s.constraints_resources,
      'Your Role':s.role
    }).map(([k,v])=>`<tr><td style="width:260px;font-weight:bold;background:#f5f5f5">${escapeHTML(k)}</td><td>${paragraphsHTML(v||'')}</td></tr>`).join('')}
  </table>`;
  const html=`<h1>${escapeHTML(s.title||'Untitled')}</h1>
    <p><strong>${escapeHTML(CONFIG.COURSE_TAG)}</strong></p>
    <h2>Scenario Details</h2>${gridHTML}
    <h2>Scenario Context & Stakeholders</h2><p>${escapeHTML(d.fields.context).replace(/\n/g,'<br>')}</p>
    <h2>Your Program or Practice Design</h2><p>${escapeHTML(d.fields.design).replace(/\n/g,'<br>')}</p>
    <h2>Evaluation Purpose & Questions</h2><p>${escapeHTML(d.fields.purpose).replace(/\n/g,'<br>')}</p>
    <h2>Outcomes (Conceptualization)</h2><p>${escapeHTML(d.fields.outcomes).replace(/\n/g,'<br>')}</p>
    <h2>Operationalization & Data Sources</h2><p>${escapeHTML(d.fields.operational).replace(/\n/g,'<br>')}</p>
    <h2>Evaluation Design Plan</h2><p>${escapeHTML(d.fields.designplan).replace(/\n/g,'<br>')}</p>
    <h2>Ethics, Power, Limitations & Communication</h2><p>${escapeHTML(d.fields.ethics).replace(/\n/g,'<br>')}</p>
    ${d.fields.assumptions?.trim()?`<h2>Assumptions</h2><p>${escapeHTML(d.fields.assumptions).replace(/\n/g,'<br>')}</p>`:''}
    <p><em>Exported: ${escapeHTML(d.timestamp)}</em></p>`;
  window.htmlDocx.asBlobAsync(html).then(function(blob){
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    const safe=(s.title||'Program_Evaluation').replace(/[^\w\-]+/g,'_').slice(0,80)+'.docx';
    a.download=safe||CONFIG.DEFAULT_EXPORT_NAME;
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{URL.revokeObjectURL(a.href);a.remove();},0);
    toast('Exported .docx');
  }).catch(function(err){
    console.error(err); toast('Export failed');
  });
}
function onNew(){clearBuilder(); lastSavedHash=''; toast('Cleared')}
</script>

<!-- ===== DOCX exporter shim (unchanged) ===== -->
<script>
(()=>{function utf8Bytes(str){str=String(str);const b=[];for(let i=0;i<str.length;i++){let c=str.charCodeAt(i);if(c>=0xD800&&c<=0xDBFF&&i+1<str.length){const c2=str.charCodeAt(++i);if((c2&0xFC00)===0xDC00){c=0x10000+((c-0xD800)<<10)+(c2-0xDC00)}else{i--}}if(c<=0x7F)b.push(c);else if(c<=0x7FF)b.push(0xC0|(c>>6),0x80|(c&0x3F));else if(c<=0xFFFF)b.push(0xE0|(c>>12),0x80|((c>>6)&0x3F),0x80|(c&0x3F));else b.push(0xF0|(c>>18),0x80|((c>>12)&0x3F),0x80|((c>>6)&0x3F),0x80|(c&0x3F))}return new Uint8Array(b)}
const CRC_TABLE=(()=>{let c,t=[];for(let n=0;n<256;n++){c=n;for(let k=0;k<8;k++){c=((c&1)?(0xEDB88320^(c>>>1)):(c>>>1))}t[n]=c>>>0}return t})();
function crc32(u8){let c=0^(-1);for(let i=0;i<u8.length;i++){c=(c>>>8)^CRC_TABLE[(c^u8[i])&255]}return (c^(-1))>>>0}
function le16(n){return new Uint8Array([n&255,(n>>8)&255])}
function le32(n){return new Uint8Array([n&255,(n>>8)&255,(n>>16)&255,(n>>24)&255])}
function cat(chunks){const L=chunks.reduce((a,b)=>a+b.length,0);const out=new Uint8Array(L);let o=0;for(const c of chunks){out.set(c,o);o+=c.length}return out}
function zipBlobSync(files,mime){const LFH=0x04034b50,CDH=0x02014b50,EOCD=0x06054b50,ver=20,gpbf=0x0800,method=0;const now=new Date();const dosTime=((now.getHours()<<11)|(now.getMinutes()<<5)|(Math.floor(now.getSeconds()/2)));const dosDate=(((now.getFullYear()-1980)<<9)|((now.getMonth()+1)<<5)|now.getDate());const lfhChunks=[];const centrals=[];let offset=0;const headers=[];for(const f of files){const name=utf8Bytes(f.name);const data=f.data;const sum=crc32(data);const lfh=cat([le32(LFH),le16(ver),le16(gpbf),le16(method),le16(dosTime),le16(dosDate),le32(sum),le32(data.length),le32(data.length),le16(name.length),le16(0),name,data]);lfhChunks.push(lfh);headers.push({name,sum,size:data.length,offset,dosTime,dosDate});offset+=lfh.length}const startCD=offset;for(const h of headers){const cdh=cat([le32(CDH),le16(0x033F),le16(0x003F),le16(gpbf),le16(method),le16(h.dosTime),le16(h.dosDate),le32(h.sum),le32(h.size),le32(h.size),le16(h.name.length),le16(0),le16(0),le16(0),le16(0),le32(0),le32(h.offset),h.name]);centrals.push(cdh);offset+=cdh.length}const centralDir=cat(centrals);const end=cat([le32(EOCD),le16(0),le16(0),le16(headers.length),le16(headers.length),le32(centralDir.length),le32(startCD),le16(0)]);const zip=cat([...lfhChunks,centralDir,end]);return new Blob([zip],{type:mime||'application/zip'})}
function sanitize(text){return String(text||"").replace(/[\u2013\u2014]/g,"-").replace(/[\p{Extended_Pictographic}\uFE0F]/gu,"")}
function esc(s){return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}
function runText(t){return `<w:r><w:t xml:space="preserve">${esc(t)}</w:t></w:r>`}
function p(children,style){return `<w:p>${style?`<w:pPr><w:pStyle w:val="${style}"/></w:pPr>`:""}${children||""}</w:p>`}
function heading(text,level){const map={1:"Heading1",2:"Heading2",3:"Heading3"};return p(runText(text),map[level]||"Heading2")}
function paragraphFromHTML(node){let out="";node.childNodes.forEach(ch=>{if(ch.nodeType===3){out+=runText(ch.nodeValue||"");}else if(ch.nodeName==="BR"){out+='<w:r><w:br/></w:r>';}else if(ch.nodeType===1){out+=paragraphFromHTML(ch);}});return out;}
function para(text){return p(runText(text),null)}
function parseHTMLtoDoc(xmlString){const dom=new DOMParser().parseFromString(`<div>${xmlString}</div>`,'text/html');const root=dom.body.firstChild||dom.body;const blocks=root.querySelectorAll('h1,h2,h3,p,table');let bodyParts=[];if(blocks.length===0){bodyParts=[para(sanitize(root.textContent||''))]}else{blocks.forEach(el=>{const tag=el.tagName.toLowerCase();if(tag==='h1'){bodyParts.push(heading(el.textContent||'',1))}else if(tag==='h2'){bodyParts.push(heading(el.textContent||'',2))}else if(tag==='h3'){bodyParts.push(heading(el.textContent||'',3))}else if(tag==='p'){bodyParts.push(p(paragraphFromHTML(el),null))}else if(tag==='table'){const rows=[...el.querySelectorAll('tr')].map(tr=>{const cells=[...tr.children].map(td=>{const txt=td.textContent||'';return `<w:tc><w:tcPr/><w:p><w:r><w:t xml:space="preserve">${esc(txt)}</w:t></w:r></w:p></w:tc>`;}).join('');return `<w:tr>${cells}</w:tr>`;}).join('');bodyParts.push(`<w:tbl><w:tblPr/><w:tblGrid/>${rows}</w:tbl>`);}});}return bodyParts.join('');}
function buildDocxFromHTML(htmlInput){const safe=sanitize(htmlInput);const docBody=parseHTMLtoDoc(safe);const styles=`<?xml version="1.0" encoding="UTF-8" standalone="yes"?><w:styles xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main"><w:style w:type="paragraph" w:styleId="Heading1"><w:name w:val="heading 1"/><w:basedOn w:val="Normal"/><w:pPr><w:keepNext/><w:keepLines/></w:pPr><w:rPr><w:b/><w:sz w:val="32"/></w:rPr></w:style><w:style w:type="paragraph" w:styleId="Heading2"><w:name w:val="heading 2"/><w:basedOn w:val="Normal"/><w:pPr><w:keepNext/><w:keepLines/></w:pPr><w:rPr><w:b/><w:sz w:val="28"/></w:rPr></w:style><w:style w:type="paragraph" w:styleId="Heading3"><w:name w:val="heading 3"/><w:basedOn w:val="Normal"/><w:pPr><w:keepNext/><w:keepLines/></w:pPr><w:rPr><w:b/><w:sz w:val="24"/></w:rPr></w:style></w:styles>`;const contentTypes=`<?xml version="1.0" encoding="UTF-8"?><Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types"><Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/><Default Extension="xml" ContentType="application/xml"/><Override PartName="/word/document.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml"/><Override PartName="/word/styles.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.styles+xml"/></Types>`;const rootRels=`<?xml version="1.0" encoding="UTF-8"?><Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships"><Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="word/document.xml"/></Relationships>`;const docRels=`<?xml version="1.0" encoding="UTF-8"?><Relationships xmlns="http://schemas.openxmlformats.org/officeDocument/2006/relationships"><Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/styles" Target="styles.xml"/></Relationships>`;const documentXML=`<?xml version="1.0" encoding="UTF-8" standalone="yes"?><w:document xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main"><w:body>${docBody}<w:sectPr/></w:body></w:document>`;const files=[{name:'[Content_Types].xml',data:utf8Bytes(contentTypes)},{name:'_rels/.rels',data:utf8Bytes(rootRels)},{name:'word/document.xml',data:utf8Bytes(documentXML)},{name:'word/_rels/document.xml.rels',data:utf8Bytes(docRels)},{name:'word/styles.xml',data:utf8Bytes(styles)}];return zipBlobSync(files,'application/vnd.openxmlformats-officedocument.wordprocessingml.document');}
const api=window.htmlDocx||{};api.asBlob=function(html){return buildDocxFromHTML(html);};api.asBlobAsync=function(html){return Promise.resolve(buildDocxFromHTML(html));};window.htmlDocx=api;})();
</script>

</body>
</html>
