<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Program Evaluation Generator</title>
  <style>
    :root{ --bg:#f6f7fb;--card:#ffffff;--ink:#111827;--muted:#6b7280;--primary:#6d28d9;--primary-ink:#fff;--ring:#c4b5fd;--ok:#059669;--warn:#b45309;}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";color:var(--ink);background:var(--bg)}
    .container{max-width:1200px;margin:0 auto;padding:20px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px}
    .title{font-weight:800;font-size:20px}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px}
    button{appearance:none;border:1px solid transparent;background:var(--primary);color:var(--primary-ink);padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer}
    button.ghost{background:transparent;color:var(--ink);border-color:#e5e7eb}
    button.secondary{background:#111827;color:#fff}
    button:disabled{opacity:.55;cursor:not-allowed}
    .grid{display:grid;grid-template-columns:1fr 1.3fr;gap:16px}
    @media (max-width: 960px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 1px 2px rgba(0,0,0,.04);padding:16px}
    .card h2{margin:0 0 8px 0;font-size:18px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .field{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
    label{font-size:12px;color:#374151;font-weight:700}
    .hint{font-size:11px;color:#6b7280}
    input,textarea{width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;color:var(--ink);font:inherit}
    textarea{min-height:120px;resize:vertical}
    .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid #e5e7eb;border-radius:999px;padding:6px 10px;font-size:12px}
    .chip{background:#f3f4f6;border:1px solid #e5e7eb;border-radius:999px;padding:6px 10px;font-size:12px}
    .hr{height:1px;background:#eef0f4;margin:12px 0}
    .status{font-size:12px}
    .footer{margin-top:14px;font-size:12px;color:var(--muted);display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .focus-ring:focus{outline:3px solid var(--ring);outline-offset:2px}
    .spin{animation:spin 1s linear infinite;display:inline-block} @keyframes spin{to{transform:rotate(360deg)}}
    .hidden{display:none}
    /* scenario paragraph spacing */
    .scenario p{margin:0 0 10px 0}
    .kvs{display:grid;grid-template-columns:200px 1fr;gap:8px}
    .kvs .muted{align-self:start}
  </style>
</head>
<body>
<div class="container">
  <header>
    <div class="row">
      <div class="title" id="siteTitle">Program Evaluation Generator</div>
      <span class="badge" id="siteSubtitle">No login ‚Ä¢ Works offline ‚Ä¢ Export Word / Copy Text</span>
    </div>
    <div class="toolbar" role="toolbar" aria-label="Main">
      <button id="btnRandom" class="focus-ring" title="Randomize a scenario (R)">üé≤ Randomize</button>
      <button id="btnLock" class="ghost focus-ring" title="Lock/unlock the current scenario (L)">üîí Lock</button>
      <button id="btnNew" class="ghost focus-ring" title="Start fresh (N)">üßº New</button>
      <button id="btnSave" class="ghost focus-ring" title="Save to this browser (S)">üíæ Save</button>
      <button id="btnLoad" class="ghost focus-ring" title="Load last (O)">üìÇ Load</button>
      <button id="btnCopyScenario" class="ghost focus-ring" title="Copy scenario as plain text">üßæ Copy Scenario</button>
      <button id="btnExport" class="secondary focus-ring" title="Export to Word (E)">‚¨áÔ∏è Export Word</button>
      <button id="btnCopy" class="ghost focus-ring" title="Copy all as plain text">üìã Copy Text</button>
      <button id="btnPrint" class="ghost focus-ring" title="Print (P)">üñ®Ô∏è Print</button>
      <button id="btnImport" class="ghost focus-ring" title="Import scenarios JSON">üì• Import</button>
      <button id="btnExportCases" class="ghost focus-ring" title="Export scenarios JSON">üì§ Export</button>
      <input id="fileInput" type="file" accept="application/json" class="hidden"/>
    </div>
  </header>

  <div class="grid" id="app">
    <section class="card" aria-labelledby="caseTitle">
      <h2 id="caseTitle">Scenario</h2>
      <div id="caseEmpty" class="muted">Click <strong>Randomize</strong> to draw a scenario. Lock to begin writing.</div>

      <div id="caseWrap" hidden>
        <div class="row" style="justify-content:space-between;align-items:flex-start">
          <div class="row" style="gap:8px;align-items:center">
            <div class="badge hidden" id="caseId">ID</div>
            <div class="chip hidden" id="caseTitleChip"></div>
          </div>
          <div class="status" id="lockStatus"></div>
        </div>

        <div class="hr"></div>
        <div class="kvs scenario">
          <div class="muted">Title</div><div id="vTitle"></div>
          <div class="muted">Setting snapshot</div><div id="vSetting"></div>
          <div class="muted">Population snapshot</div><div id="vPopulation"></div>
          <div class="muted">Core problems / tensions</div><div id="vCore"></div>
          <div class="muted">Stakeholder glimpses</div><div id="vStake"></div>
          <div class="muted">Structural / equity signals</div><div id="vEquity"></div>
          <div class="muted">Known constraints / resources</div><div id="vConstraints"></div>
          <div class="muted">Your role</div><div id="vRole"></div>
        </div>
      </div>
    </section>

    <section class="card" aria-labelledby="builderTitle">
      <h2 id="builderTitle">Program Evaluation Builder</h2>
      <div id="lockGate" class="muted">Lock a scenario to enable editing.</div>
      <div id="builder" hidden>
        <div class="field">
          <label for="fContext">1) Scenario Context & Stakeholders</label>
          <div class="hint">Summarize setting, population, core problems you will focus on. Name key stakeholders and what each wants. Include 1‚Äì2 structural/equity factors.</div>
          <textarea id="fContext"></textarea>
          <div class="row"><span class="status" id="cntContext">0 words</span></div>
        </div>

        <div class="field">
          <label for="fDesign">2) Your Program or Practice Design</label>
          <div class="hint">Describe what you propose, who it is for, components (format, frequency, roles), and a short theory of change.</div>
          <textarea id="fDesign"></textarea>
          <div class="row"><span class="status" id="cntDesign">0 words</span></div>
        </div>

        <div class="field">
          <label for="fPurpose">3) Evaluation Purpose & Questions</label>
          <div class="hint">Why evaluate now and what decisions it will inform. Add 2‚Äì3 clear evaluation questions (include at least one outcome and one experience/access/structural).</div>
          <textarea id="fPurpose"></textarea>
          <div class="row"><span class="status" id="cntPurpose">0 words</span></div>
        </div>

        <div class="field">
          <label for="fOutcomes">4) Outcomes (Conceptualization)</label>
          <div class="hint">Name 2‚Äì3 outcomes/phenomena. Define in context. Contrast with policy/system definitions.</div>
          <textarea id="fOutcomes"></textarea>
          <div class="row"><span class="status" id="cntOutcomes">0 words</span></div>
        </div>

        <div class="field">
          <label for="fMeasures">5) Operationalization & Data Sources</label>
          <div class="hint">For each outcome, propose at least two measures with data source/level, pros/cons, equity implications.</div>
          <textarea id="fMeasures"></textarea>
          <div class="row"><span class="status" id="cntMeasures">0 words</span></div>
        </div>

        <div class="field">
          <label for="fDesignPlan">6) Evaluation Design Plan</label>
          <div class="hint">Design type, who is included, when data are collected, and a brief map of Questions ‚Üí Outcomes ‚Üí Measures. Note feasibility.</div>
          <textarea id="fDesignPlan"></textarea>
          <div class="row"><span class="status" id="cntDesignPlan">0 words</span></div>
        </div>

        <div class="field">
          <label for="fEthics">7) Ethics, Power, Limitations & Communication</label>
          <div class="hint">How data help vs harm, power/surveillance risks, structural factors, at least 2 limitations, and a 1‚Äì2 sentence participant message.</div>
          <textarea id="fEthics"></textarea>
          <div class="row"><span class="status" id="cntEthics">0 words</span></div>
        </div>

        <div class="field">
          <label for="fAssumptions">Assumptions I am Making (optional)</label>
          <div class="hint">Note reasonable assumptions due to missing or ambiguous details.</div>
          <textarea id="fAssumptions"></textarea>
        </div>

        <div class="hr"></div>
        <div class="row" style="justify-content:space-between">
          <div class="badge">Progress</div>
          <div id="progress" class="status">0/7 sections with 100+ words</div>
        </div>
      </div>
    </section>
  </div>

  <div class="footer">
    <span>Autosave:</span><span id="saveStatus">idle</span>
    <span class="muted">‚Ä¢</span><span id="tip">Tip: R = Randomize, L = Lock, E = Export Word.</span>
  </div>
</div>

<script>
  // ======= CONFIG =======
  const CONFIG = {
    siteTitle: "Program Evaluation Generator",
    siteSubtitle: "No login ‚Ä¢ Works offline ‚Ä¢ Export Word / Copy Text",
    exportFileName: "Program_Evaluation_Note.doc"
  };

  // ======= Utilities =======
  const noDash=(s)=>(s||'').toString().replace(/[‚Äî‚Äì]/g,'-');
  const stripDashesDeep = (v)=>{
    if(Array.isArray(v)) return v.map(stripDashesDeep);
    if(v && typeof v==='object'){ const o={}; for(const k in v) o[k]=stripDashesDeep(v[k]); return o; }
    if(typeof v==='string') return noDash(v);
    return v;
  };
  const $ = (sel)=>document.querySelector(sel);
  const uid=()=>Math.random().toString(36).slice(2,9);
  const nowISO=()=>new Date().toISOString();
  const wordCount=(s)=>(s||"").trim().split(/\s+/).filter(Boolean).length;
  const sanitize=(s)=>(s||"").toString().replace(/[\t\r]/g,' ').trim();
  const debounce=(fn,ms=800)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn.apply(null,a),ms);};};
  const escapeHtml=s=>(s||'').replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));
  function paragraphsHTML(text){
    const safe = noDash(text||'').replace(/\r\n/g,'\n');
    const blocks = safe.split(/\n\s*\n/).map(t=>t.trim()).filter(Boolean);
    return blocks.map(b=>`<p>${escapeHtml(b)}</p>`).join('');
  }

  // ======= Scenarios (15) =======
  let SCENARIOS = stripDashesDeep([
    {
      id:"case_01_jefferson_discipline",
      title:"Discipline at Jefferson Middle: Suspensions and 'Defiance'",
      setting_snapshot:`Jefferson Middle School is a large, majority-Black public school in an urban district. The building is old; some classroom windows are painted shut, and the heaters rattle in winter. Hallways are crowded during every class change. The school has one full-time social worker, a part-time behavior specialist shared with another campus, and a school resource officer assigned three days a week.`,
      population_snapshot:`Most students live within a 3‚Äì4 mile radius. Many caregivers work variable shifts in healthcare, service, or warehouse jobs. About 80% of students qualify for free/reduced lunch. The ‚Äúhigh needs‚Äù roster combines students with IEPs, 504 plans, and those with 5+ office referrals; Black students and students with disabilities are overrepresented on that list and in suspension data.`,
      core_problems:`Over the past two years, out-of-school suspensions have climbed, especially for ‚Äúdefiance,‚Äù ‚Äúdisruption,‚Äù and ‚Äúnoncompliance.‚Äù Teachers describe write-ups for refusing to put away phones, walking out of class, and hallway conflicts leading to suspensions. The social worker is called often to de-escalate. Many frequent flyers have recent stressors that rarely appear in discipline records. Teachers are burning out; families are frustrated. The district flagged Jefferson for disproportionate discipline and demanded a plan.`,
      stakeholder_glimpses:`Principal: Reduce suspensions without alienating staff.\nTeachers: Mix of demand for consequences and desire for support.\nStudents: Some feel targeted; some avoid school due to ‚Äúdrama.‚Äù\nFamilies: Mixed trust; worry about juvenile justice involvement.\nDistrict leaders: Focus on suspension metrics and disproportionality.`,
      equity_signals:`Racial and disability disparities in referrals and suspensions; vague categories rely on adult interpretation; policing presence; limited youth-friendly mental health services; accountability pressures valuing order and test scores.`,
      constraints_resources:`Limited space; one social worker, part-time specialist, SRO presence; mandatory PD hours are packed; small one-year innovation grant up to $10,000; local youth nonprofit interested but not yet partnered.`,
      role:`As the MSW social worker/evaluator, propose a specific, realistic practice change and outline how you will evaluate whether it helps.`
    },
    {
      id:"case_02_hospital_unhoused",
      title:"Discharge to Nowhere: Unhoused Patients at City General",
      setting_snapshot:`City General is a busy safety-net hospital. Social workers juggle crisis consults and discharge planning; ED hallways are often lined with stretchers.`,
      population_snapshot:`Many adult inpatients are unhoused or precariously housed with co-occurring chronic illness, mental health diagnoses, and substance use; some are on probation or lack ID.`,
      core_problems:`30-day readmissions for unhoused patients are nearly double housed patients. Staff see familiar faces returning. Patients report rushed, confusing discharges and unsafe conditions post-discharge. Staff feel pressured to move people out; social workers face moral distress with limited placement options.`,
      stakeholder_glimpses:`Leadership: Concerned about penalties and throughput.\nMedical staff: Want fewer bounce-backs, safer discharges.\nSocial work/case mgmt: Stretched thin.\nPatients: Want respect and realistic plans.\nCommunity partners: At capacity; feel ‚Äúdumped‚Äù on.`,
      equity_signals:`Criminalization of homelessness; racialized patterns of who becomes and stays unhoused; insurance gaps; lack of medical respite; policy incentives for rapid discharge.`,
      constraints_resources:`No capacity for new units; limited motel vouchers; must work within current staffing; EHR can track readmissions/ED visits; FQHC and one shelter interested in coordination; leadership open to a small targeted pilot.`,
      role:`Design a small-scale discharge planning program or practice tweak for unhoused patients and outline an evaluation of outcomes and experiences.`
    },
    {
      id:"case_03_lgbtq_northside",
      title:"We Don't Feel Safe Here: LGBTQ+ Students at Northside High",
      setting_snapshot:`Suburban high school with one counselor, a shared social worker, no recognized GSA; campus spread across multiple buildings.`,
      population_snapshot:`Majority White with growing Black, Latine, and immigrant students; visible group of queer and trans students clustering in supportive spaces.`,
      core_problems:`Increased bullying/harassment reports with social media incidents. Staff split between supportive and minimizing responses. Admin sends generic emails; no specific LGBTQ+ policies or trainings. Students avoid bathrooms, certain hallways, and sometimes school.`,
      stakeholder_glimpses:`LGBTQ+ students: Safety, correct names/pronouns, brave adults.\nOther students: Range from bullying to quietly supportive.\nStaff: Need tools and admin backing; fear backlash.\nAdmin: Wants fewer reports, less controversy.\nFamilies: Mixed views.`,
      equity_signals:`State-level debates on LGBTQ+ issues; religious/cultural beliefs; intersection with race/disability/immigration; policies lacking explicit protections.`,
      constraints_resources:`Limited PD time; no dedicated LGBTQ+ budget or staff; informal lunch group exists; local LGBTQ+ youth center interested; general anti-bullying policy lacks implementation guidance.`,
      role:`Propose a specific program/practice to improve safety and belonging and design an evaluation to understand impact.`
    },
    {
      id:"case_04_newcomer_eastview",
      title:"Lost in Translation: Newcomer Students at Eastview Middle",
      setting_snapshot:`Mid-sized city school with an ESOL teacher and part-time interpreter services by phone/video.`,
      population_snapshot:`About 30% multilingual students; newcomers from Central America, the Middle East, Southeast Asia; some with gaps in schooling or trauma.`,
      core_problems:`Quiet compliance with failing assessments, acting out, or skipping class. Family communications often in English only. Misplacement into lower-level courses due to English level; IEP referrals without full cultural/linguistic consideration.`,
      stakeholder_glimpses:`Students: Want friends, understanding, and support.\nFamilies: Want success but may fear systems.\nTeachers: Want to adapt but lack time/training.\nAdmin: Worried about accountability metrics.`,
      equity_signals:`Language barriers; immigration status and trauma; tracking into lower coursework; English-only metrics of success.`,
      constraints_resources:`Limited ESOL hours; interpreter service requires planning; resettlement agency has evening programs; small grant possible; no new full-time positions promised.`,
      role:`Design a support program/practice for newcomer/multilingual students and families and outline an evaluation on access, experience, and outcomes.`
    },
    {
      id:"case_05_rsu_counseling",
      title:"Always Waiting: College Counseling Center at River State University",
      setting_snapshot:`Public university counseling center with psychologists, social workers, and trainees; reputation for being overbooked.`,
      population_snapshot:`Diverse students, many first-gen balancing work/school; concerns include anxiety, depression, trauma, family conflict, substance use, academics.`,
      core_problems:`Waits of 3‚Äì4 weeks for intake; some never make it past the waitlist; staff burnout. Students complain about delays and retelling their story.`,
      stakeholder_glimpses:`Students: Timely, culturally responsive support.\nStaff: Quality care without burnout.\nAdministration: Proactive optics and access.\nFaculty: Clear referral pathways.`,
      equity_signals:`First-gen and low-income stress; stigma and mistrust; representation gaps among providers; insurance/off-campus barriers.`,
      constraints_resources:`Limited space; potential to reconfigure scheduling, groups, stepped care; some pilot funding if it reduces waits; ties to off-campus providers.`,
      role:`Propose a concrete program/practice change (e.g., brief track, workshops, triage protocol) and design an evaluation for access, experience, and outcomes.`
    },
    {
      id:"case_06_dv_shelter",
      title:"We're Just a Bed, Not a Solution: DV Shelter Survivors Program",
      setting_snapshot:`Safe Harbor House is a confidential emergency shelter with 18 beds, two case managers, a children‚Äôs advocate, and a part-time clinical social worker.`,
      population_snapshot:`Mostly women and children; mix of racial/cultural backgrounds; some undocumented; stays typically 30‚Äì60 days.`,
      core_problems:`Residents cycle through; early returns to partners; juggling court, jobs, school with trauma and childcare. Loose groups and variable participation; unclear if services help.`,
      stakeholder_glimpses:`Residents: Safety, non-judgment, practical help.\nStaff: Structure without rigidity; meaning in efforts.\nBoard/funders: Evidence of effectiveness.\nPartners: Narrow outcome views like permanent separation.`,
      equity_signals:`Economic dependence; immigration fears; trauma-uninformed systems; racism and stereotypes.`,
      constraints_resources:`Limited staff; no on-site childcare; some grant flexibility; basic data but no standardized measures.`,
      role:`Design a structured program component (group, individualized track, follow-up outreach) and plan an evaluation for survivor experience and key outcomes.`
    },
    {
      id:"case_07_transitional_youth",
      title:"A Roof, Not a Home: Transitional Housing for Youth Aging Out of Care",
      setting_snapshot:`BridgePoint House has studio apartments with two case managers and a life skills coach.`,
      population_snapshot:`Young adults 18‚Äì24 with system involvement, trauma, disrupted schooling; some are parents.`,
      core_problems:`Program emphasizes housing stability, less on wellbeing or connection. Isolation, conflicts, early exits, disengagement. Funders track exits to housing but miss wellbeing.`,
      stakeholder_glimpses:`Residents: Autonomy, respect, non-surveillant support.\nStaff: Trust-building without rigid rules.\nFunders: Measurable outcomes.\nCommunity partners: Unsure how to engage.`,
      equity_signals:`Systemic racism/classism; barriers for youth with records; lack of affordable housing; stigma.`,
      constraints_resources:`Limited 1:1 capacity; groups more feasible; small budget for stipends/activities; basic length-of-stay and exit data; little on mental health/belonging.`,
      role:`Design a program element (peer-led group, mentorship, coaching, partnered activity) and outline an evaluation of impact on youth experience and outcomes.`
    },
    {
      id:"case_08_cfs_productivity",
      title:"Productivity or People? Quotas at Community Family Services",
      setting_snapshot:`CFS provides outpatient therapy, case management, and parenting support; mostly Medicaid-insured families in a large metro area.`,
      population_snapshot:`Families navigating poverty, housing instability, child welfare, parental MH/SUD, IPV; many single parents or grandparents raising grandchildren.`,
      core_problems:`Stricter productivity targets push short sessions and less coordination. Clients feel rushed; some drop out. Leadership worries about revenue; open to small changes.`,
      stakeholder_glimpses:`Clinicians: Relational work and flexibility.\nSupervisors: Support staff while meeting budgets.\nExecutive/Board: Financial viability and retention.\nClients: Feeling heard; flexible options.`,
      equity_signals:`Reimbursement rewarding billable hours over advocacy; impact on families with higher structural barriers; risk of pushing out client-centered staff.`,
      constraints_resources:`Cannot reduce overall billables dramatically; potential pilots for subsets (scheduling templates, group + individual blends); EHR/billing data; basic satisfaction forms.`,
      role:`Propose a targeted adjustment (pilot caseload model, integrated group+individual, structured relational time) and design an evaluation for client experience and key metrics.`
    },
    {
      id:"case_09_peds_complex",
      title:"In and Out of the Room: Medically Complex Kids on the Pediatric Unit",
      setting_snapshot:`Memorial Children‚Äôs Hospital pediatric unit with semi-private rooms; child life specialist, social worker, rotating residents and nurses.`,
      population_snapshot:`Infants through teens with complex conditions; diverse families; some rural; subset with child welfare involvement.`,
      core_problems:`Questions about caregiver follow-through; repeated readmissions; caregivers overwhelmed by work, transport, health literacy; tension with child welfare involvement and equity concerns.`,
      stakeholder_glimpses:`Caregivers: Respectful, clear communication.\nNurses/physicians: Safe home care readiness.\nSocial worker: Prevent unnecessary CPS involvement.\nCW workers: Safety assessments with limited time.\nLeadership: Readmissions and quality scores.`,
      equity_signals:`Disparities in labeling and CPS reporting; language/health literacy; limited home supports; policies treating missed appointments as caregiver failure.`,
      constraints_resources:`No new positions; teaching materials exist but not always plain-language or multilingual; small grant for caregiver engagement; EHR tracks readmissions/LOS.`,
      role:`Design a program/practice to support families (teaching protocols, peer support, discharge tweaks) and outline an evaluation of outcomes and experiences.`
    },
    {
      id:"case_10_youth_reentry_hub",
      title:"Out and Back Again: Youth Reentry Drop-In Center",
      setting_snapshot:`Horizon Hub near bus hub and courthouse serves ages 16‚Äì24 on probation, recently released, or aging out.`,
      population_snapshot:`Mostly Black and Latine youth with school exclusion, family instability, trauma; some parents; juggling probation, jobs, court, housing.`,
      core_problems:`Hub provides basics without structured program; engagement is episodic. Funders and probation want outcomes; Hub has limited data.`,
      stakeholder_glimpses:`Youth: Respect, practical help, non-surveillance spaces.\nStaff: Deepen services without mission drift.\nProbation: Engagement proof and fewer violations.\nFunders/Board: Recidivism, employment, education.\nCommunity: Mixed perceptions.`,
      equity_signals:`School-to-prison pipeline; concentrated policing; tension between carceral logic and youth development; barriers to ID, employment, housing.`,
      constraints_resources:`Small staff and space; flexible room; grant requires documentation of services/outcomes; partners include legal aid, community college, employers.`,
      role:`Design a realistic program track (planning series, peer-led groups, structured case management) and develop an evaluation for youth experience and reentry outcomes.`
    },
    {
      id:"case_11_riverside_overdose",
      title:"More Sirens at Night: Overdoses in the Riverside Neighborhood",
      setting_snapshot:`Working-class neighborhood near industrial corridor with visible drug use and increased police presence.`,
      population_snapshot:`Long-term older Black/White residents and newer young renters; many face job loss, health issues, and limited transport; portion uses opioids publicly.`,
      core_problems:`Sharp rise in overdoses/deaths over 18 months; EMS repeat runs; community meetings divided between enforcement and harm reduction; small harm reduction van operates with limited coverage.`,
      stakeholder_glimpses:`PWUD: Stay alive, avoid withdrawal, respect.\nFamily members: Safety and care access.\nNeighbors: Safety and cleanliness concerns.\nPolice: Pressure to act; mixed harm reduction buy-in.\nHealth dept: Open to innovative strategies.`,
      equity_signals:`Deindustrialization and instability; criminalization; underfunded services; stigma shaping who is seen as deserving.`,
      constraints_resources:`Limited funding; available data from EMS/ED; existing harm reduction group with peer workers; community tensions to navigate.`,
      role:`Design an overdose response or harm reduction initiative and an evaluation plan for overdose risk, safety perceptions, and equity.`
    },
    {
      id:"case_12_lincoln_iep",
      title:"Whose Plan Is It? IEP Conflict at Lincoln Elementary",
      setting_snapshot:`Neighborhood K‚Äì5 with resource room, speech office, small sensory space; part-time psychologist; shared social worker.`,
      population_snapshot:`Diverse families; many hourly workers; noticeable number receiving special education services.`,
      core_problems:`Contentious IEP meetings; families feel outnumbered and rushed; staff feel attacked; examples include restrictive placement pressure, English-only drafts minutes before meetings.`,
      stakeholder_glimpses:`Families: Partnership and understandable language.\nTeachers: Support for behavior and differentiation.\nSpecial ed staff: Compliance and services under constraints.\nAdministrators: Avoid due process and manage burnout.\nStudents: Belonging in classrooms.`,
      equity_signals:`Racial/disability disparities; power imbalances; language access; paperwork compliance over relationships.`,
      constraints_resources:`Limited time for long meetings or pre-meetings; standard district trainings; some flexibility to pilot meeting formats and tools; local parent advocacy org exists.`,
      role:`Design a support or practice change to improve family‚Äìschool collaboration and outline an evaluation for family/staff experience and IEP outcomes.`
    },
    {
      id:"case_13_oakwood_asthma",
      title:"Hard to Breathe: Asthma and Air Quality in Oakwood",
      setting_snapshot:`Low-income neighborhood near highway and warehouses; community clinic plus a small environmental justice org.`,
      population_snapshot:`Predominantly Black and Latine families in older rentals with mold, pests, poor ventilation; many parents in service/warehouse/gig work.`,
      core_problems:`Higher child asthma, ER visits, and missed school; families struggle with landlords and get one-time medical education focused on meds; EJ group collected air data with limited follow-through.`,
      stakeholder_glimpses:`Families: Kids breathing easier, fewer ER trips, leverage with landlords.\nClinic: Reduce acute visits; better chronic care under time limits.\nEJ group: Turn data into action and power.\nSchools: Absences tied to asthma.\nCity/public health: Aware but juggling demands.`,
      equity_signals:`Environmental racism; landlord-tenant power; insurance/access barriers; school metrics miss structural determinants.`,
      constraints_resources:`Visit time limited; EJ volunteers and data skills; small grant for community‚Äìclinic asthma initiative; data from EHR and community assessment; possibly school attendance records.`,
      role:`Design a clinic‚Äìcommunity initiative (CHW visits, tenant support, school-clinic partnership, action groups) and evaluate child health, family empowerment, and equity.`
    },
    {
      id:"case_14_rural_mobile",
      title:"We Only Come on Thursdays: Rural Mobile Health Clinic",
      setting_snapshot:`Mobile van rotates among rural communities; parks at churches, schools, grocery lots; provides basic primary care and brief BH screens.`,
      population_snapshot:`Older adults, farmworkers, families with limited transport; many uninsured/underinsured; spotty interpreter services; limited broadband.`,
      core_problems:`Irregular follow-up and short visits; coordination challenges; community appreciates access but misses van due to schedule/work conflicts; staff want to support chronic disease and MH but feel constrained.`,
      stakeholder_glimpses:`Residents: Respectful local care without long drives.\nVan staff: Balance reach and depth.\nLocal leaders: Healthier communities, trusted spaces.\nHealth system: Show impact and justify costs.`,
      equity_signals:`Rural disparities; transportation barriers; digital divide; immigration concerns among farmworkers.`,
      constraints_resources:`Fixed van capacity; limited route frequency; some grant funding for chronic disease/BH pilots; basic EHR data on visits/diagnoses/labs; trusted local institutions.`,
      role:`Design a practice modification (follow-up system, CHW role, group visits, reminders) and an evaluation for access, continuity, and experience.`
    },
    {
      id:"case_15_brookside_safety",
      title:"Safe or Watched? The City's Crime Prevention Initiative",
      setting_snapshot:`Neighborhood Safety Zones bring increased patrols, cameras, and small grants for community programming in three areas including Brookside, a historically Black community.`,
      population_snapshot:`Deep-rooted social networks amid disinvestment, closures, and rising rents.`,
      core_problems:`Visible patrols and cameras; pop-up events led by outsiders; mixed resident reactions; youth report more stops; leaders frustrated by top-down decisions. City wants data to show what works with little guidance.`,
      stakeholder_glimpses:`Residents: Safety without harassment; real voice.\nYouth: Spaces to gather and feel respected.\nPolice: Reduce crime stats; mixed views on relationships.\nCity: Measurable reductions and political optics.\nCommunity orgs: Funding interest with skepticism of surveillance.`,
      equity_signals:`History of racialized policing; disinvestment and instability; tension between crime stats and community-defined safety; risk of counting arrests as success.`,
      constraints_resources:`Modest city funds for community-led safety programs; crime data and some surveys exist; no restriction on lead agency type; grassroots groups present but wary.`,
      role:`Design a community-led program (youth peace fellows, restorative circles, tenant safety organizing) and outline an evaluation centering community-defined safety and equity along with required city metrics.`
    }
  ]);

  // ======= State & elements =======
  let current=null, locked=false;
  let showIds=false; // hidden by default
  const F = {
    context:$('#fContext'), design:$('#fDesign'), purpose:$('#fPurpose'),
    outcomes:$('#fOutcomes'), measures:$('#fMeasures'),
    designPlan:$('#fDesignPlan'), ethics:$('#fEthics'), assumptions:$('#fAssumptions')
  };
  const els = {
    caseEmpty:$('#caseEmpty'), caseWrap:$('#caseWrap'), caseId:$('#caseId'), lockStatus:$('#lockStatus'),
    caseTitleChip:$('#caseTitleChip'),
    vTitle:$('#vTitle'), vSetting:$('#vSetting'), vPopulation:$('#vPopulation'), vCore:$('#vCore'),
    vStake:$('#vStake'), vEquity:$('#vEquity'), vConstraints:$('#vConstraints'), vRole:$('#vRole'),
    lockGate:$('#lockGate'), builder:$('#builder'),
    saveStatus:$('#saveStatus'), progress:$('#progress')
  };

  // ======= Apply CONFIG =======
  (function applyConfig(){
    $('#siteTitle').textContent = CONFIG.siteTitle;
    document.title = CONFIG.siteTitle;
    $('#siteSubtitle').textContent = CONFIG.siteSubtitle;
  })();

  function applyShowIds(){
    const method = showIds ? 'remove' : 'add';
    els.caseId.classList[method]('hidden');
    els.caseTitleChip.classList[method]('hidden');
  }
  function updateLockUi(){
    els.lockStatus.innerHTML = locked ? '<span class="ok">Locked for writing</span>' : '<span class="warn">Unlocked</span>';
    $('#btnLock').textContent = locked ? 'üîì Unlock' : 'üîí Lock';
    els.lockGate.hidden = locked;
    els.builder.hidden = !locked;
  }

  function renderCase(){
    if(!current){ els.caseWrap.hidden=true; els.caseEmpty.hidden=false; return; }
    els.caseEmpty.hidden=false; els.caseWrap.hidden=false;
    $('#caseId').textContent = current.id;
    $('#caseTitleChip').textContent = noDash(current.title);
    els.vTitle.textContent = noDash(current.title);
    els.vSetting.innerHTML = paragraphsHTML(current.setting_snapshot);
    els.vPopulation.innerHTML = paragraphsHTML(current.population_snapshot);
    els.vCore.innerHTML = paragraphsHTML(current.core_problems);
    els.vStake.innerHTML = paragraphsHTML(current.stakeholder_glimpses);
    els.vEquity.innerHTML = paragraphsHTML(current.equity_signals);
    els.vConstraints.innerHTML = paragraphsHTML(current.constraints_resources);
    els.vRole.textContent = noDash(current.role);
    applyShowIds(); updateLockUi();
  }

  function randomize(){
    const b=$('#btnRandom'); b.disabled=true; b.innerHTML='<span class="spin">üé≤</span> Rolling...';
    setTimeout(()=>{
      current = SCENARIOS[Math.floor(Math.random()*SCENARIOS.length)];
      locked=false;
      clearAllFields(); renderCase();
      b.disabled=false; b.textContent='üé≤ Randomize';
      toast('New scenario drawn. Review and lock to start.');
    },600);
  }
  function toggleLock(){ if(!current){ toast('Draw a scenario first.'); return; } locked=!locked; updateLockUi(); if(locked){ loadDraft(); } }
  function clearAllFields(){ Object.values(F).forEach(el=>{ if(el) el.value=''; }); updateCounters(); }

  function updateCounters(){
    $('#cntContext').textContent = `${wordCount(F.context.value)} words`;
    $('#cntDesign').textContent = `${wordCount(F.design.value)} words`;
    $('#cntPurpose').textContent = `${wordCount(F.purpose.value)} words`;
    $('#cntOutcomes').textContent = `${wordCount(F.outcomes.value)} words`;
    $('#cntMeasures').textContent = `${wordCount(F.measures.value)} words`;
    $('#cntDesignPlan').textContent = `${wordCount(F.designPlan.value)} words`;
    $('#cntEthics').textContent = `${wordCount(F.ethics.value)} words`;
    const hits=[F.context,F.design,F.purpose,F.outcomes,F.measures,F.designPlan,F.ethics].filter(x=>wordCount(x.value)>=100).length;
    els.progress.textContent = `${hits}/7 sections with 100+ words`;
  }

  // ======= Autosave =======
  const autoKey=()=> current ? `PE_NOTE_${current.id}` : 'PE_NOTE_UNSET';
  const autosave = debounce(()=>{
    if(!current || !locked) return;
    const data = {
      case: current, locked,
      fields: {
        context:F.context.value, design:F.design.value, purpose:F.purpose.value,
        outcomes:F.outcomes.value, measures:F.measures.value,
        designPlan:F.designPlan.value, ethics:F.ethics.value, assumptions:F.assumptions.value
      },
      ts: nowISO()
    };
    try { localStorage.setItem(autoKey(), JSON.stringify(data)); els.saveStatus.textContent = `saved ${new Date().toLocaleTimeString()}`; }
    catch { els.saveStatus.textContent = 'save failed'; }
  }, 1200);
  function loadDraft(){
    const raw = localStorage.getItem(autoKey());
    if(!raw){ els.saveStatus.textContent='no draft'; return; }
    try{
      const d=JSON.parse(raw);
      F.context.value = d.fields?.context||'';
      F.design.value = d.fields?.design||'';
      F.purpose.value = d.fields?.purpose||'';
      F.outcomes.value = d.fields?.outcomes||'';
      F.measures.value = d.fields?.measures||'';
      F.designPlan.value = d.fields?.designPlan||'';
      F.ethics.value = d.fields?.ethics||'';
      F.assumptions.value = d.fields?.assumptions||'';
      updateCounters();
      els.saveStatus.textContent = `loaded draft (${new Date(d.ts).toLocaleString()})`;
    }catch{ els.saveStatus.textContent='load failed'; }
  }

  // ======= Export / Copy / Print =======
  function buildDocHtml(){
    if(!current) return '<!doctype html><html><head><meta charset="utf-8"><title>Program Evaluation</title></head><body><p>No scenario selected.</p></body></html>';
    const esc=(s)=>escapeHtml(noDash((s||'').toString()));
    const h=[];
    h.push('<!doctype html><html><head><meta charset="utf-8"><title>Program Evaluation</title>');
    h.push('<style>body{font-family:Calibri,Arial,Helvetica,sans-serif;line-height:1.45;color:#111} h1,h2,h3{margin:0 0 6px} h1{font-size:22px} h2{font-size:18px;margin-top:16px} p{margin:0 0 10px 0} ul{margin:4px 0 8px 18px} .k{color:#374151} .small{color:#555;font-size:12px} @page{margin:1in}</style></head><body>');
    h.push(`<h1>${esc(CONFIG.siteTitle)}</h1>`);
    h.push('<h2>Scenario</h2><ul>');
    h.push('<li><span class="k">Title:</span> '+esc(current.title)+'</li>');
    h.push('</ul>');
    h.push('<h3>Setting snapshot</h3>'+paragraphsHTML(current.setting_snapshot));
    h.push('<h3>Population snapshot</h3>'+paragraphsHTML(current.population_snapshot));
    h.push('<h3>Core problems / tensions</h3>'+paragraphsHTML(current.core_problems));
    h.push('<h3>Stakeholder glimpses</h3>'+paragraphsHTML(current.stakeholder_glimpses));
    h.push('<h3>Structural / equity signals</h3>'+paragraphsHTML(current.equity_signals));
    h.push('<h3>Known constraints / resources</h3>'+paragraphsHTML(current.constraints_resources));
    h.push('<h3>Your role</h3><p>'+esc(current.role)+'</p>');
    h.push('<h2>1) Scenario Context & Stakeholders</h2><p>'+esc($('#fContext').value).replace(/\n/g,'<br>')+'</p>');
    h.push('<h2>2) Your Program or Practice Design</h2><p>'+esc($('#fDesign').value).replace(/\n/g,'<br>')+'</p>');
    h.push('<h2>3) Evaluation Purpose & Questions</h2><p>'+esc($('#fPurpose').value).replace(/\n/g,'<br>')+'</p>');
    h.push('<h2>4) Outcomes (Conceptualization)</h2><p>'+esc($('#fOutcomes').value).replace(/\n/g,'<br>')+'</p>');
    h.push('<h2>5) Operationalization & Data Sources</h2><p>'+esc($('#fMeasures').value).replace(/\n/g,'<br>')+'</p>');
    h.push('<h2>6) Evaluation Design Plan</h2><p>'+esc($('#fDesignPlan').value).replace(/\n/g,'<br>')+'</p>');
    h.push('<h2>7) Ethics, Power, Limitations & Communication</h2><p>'+esc($('#fEthics').value).replace(/\n/g,'<br>')+'</p>');
    const ass = $('#fAssumptions').value;
    if(ass){ h.push('<h2>Assumptions</h2><p>'+esc(ass).replace(/\n/g,'<br>')+'</p>'); }
    h.push('<p class="small">Generated '+new Date().toLocaleString()+'</p>');
    h.push('</body></html>');
    return h.join('');
  }
  function buildPlainText(){
    if(!current) return 'No scenario selected.';
    const lines=[];
    lines.push(CONFIG.siteTitle,'');
    lines.push('Scenario');
    lines.push(`- Title: ${noDash(current.title)}`,'');
    lines.push('Setting snapshot'); lines.push(noDash(current.setting_snapshot),'');
    lines.push('Population snapshot'); lines.push(noDash(current.population_snapshot),'');
    lines.push('Core problems / tensions'); lines.push(noDash(current.core_problems),'');
    lines.push('Stakeholder glimpses'); lines.push(noDash(current.stakeholder_glimpses),'');
    lines.push('Structural / equity signals'); lines.push(noDash(current.equity_signals),'');
    lines.push('Known constraints / resources'); lines.push(noDash(current.constraints_resources),'');
    lines.push('Your role'); lines.push(noDash(current.role),'');
    lines.push('1) Scenario Context & Stakeholders'); lines.push($('#fContext').value,'');
    lines.push('2) Your Program or Practice Design'); lines.push($('#fDesign').value,'');
    lines.push('3) Evaluation Purpose & Questions'); lines.push($('#fPurpose').value,'');
    lines.push('4) Outcomes (Conceptualization)'); lines.push($('#fOutcomes').value,'');
    lines.push('5) Operationalization & Data Sources'); lines.push($('#fMeasures').value,'');
    lines.push('6) Evaluation Design Plan'); lines.push($('#fDesignPlan').value,'');
    lines.push('7) Ethics, Power, Limitations & Communication'); lines.push($('#fEthics').value,'');
    const ass=$('#fAssumptions').value; if(ass){ lines.push('Assumptions'); lines.push(ass,''); }
    lines.push(`Generated ${new Date().toLocaleString()}`);
    return lines.join('\n');
  }
  function downloadWord(){
    const html = buildDocHtml();
    const blob = new Blob([html], {type:'application/msword'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = CONFIG.exportFileName; a.click(); URL.revokeObjectURL(url);
    toast('Word file downloaded.');
  }
  async function copyPlain(){
    try{ await navigator.clipboard.writeText(buildPlainText()); toast('Copied as plain text.'); }
    catch{ toast('Copy failed. Use Export Word instead.'); }
  }
  async function copyScenario(){
    if(!current){ toast('Draw a scenario first.'); return; }
    const txt = [
      `Title: ${noDash(current.title)}`,
      `Setting snapshot: ${noDash(current.setting_snapshot)}`,
      `Population snapshot: ${noDash(current.population_snapshot)}`,
      `Core problems / tensions: ${noDash(current.core_problems)}`,
      `Stakeholder glimpses: ${noDash(current.stakeholder_glimpses)}`,
      `Structural / equity signals: ${noDash(current.equity_signals)}`,
      `Known constraints / resources: ${noDash(current.constraints_resources)}`,
      `Your role: ${noDash(current.role)}`
    ].join('\n\n');
    try{ await navigator.clipboard.writeText(txt); toast('Scenario copied.'); }
    catch{ toast('Copy failed.'); }
  }
  function printPage(){ window.print(); }

  // ======= Case Import/Export =======
  $('#btnImport').addEventListener('click', ()=>$('#fileInput').click());
  $('#fileInput').addEventListener('change', async (e)=>{
    const file = e.target.files[0]; if(!file) return;
    try{
      const text = await file.text();
      const data = JSON.parse(text);
      if(!Array.isArray(data)) throw new Error('JSON must be an array of scenarios.');
      data.forEach((c,i)=>{
        if(!c.title || !c.setting_snapshot) throw new Error(`Scenario at index ${i} missing title or setting_snapshot.`);
      });
      SCENARIOS = stripDashesDeep(data);
      toast(`Imported ${SCENARIOS.length} scenarios.`);
      e.target.value=''; // reset
    }catch(err){
      toast('Import failed: '+(err.message||'Invalid JSON'));
    }
  });
  $('#btnExportCases').addEventListener('click', ()=>{
    const blob = new Blob([JSON.stringify(SCENARIOS, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'scenarios_export.json'; a.click(); URL.revokeObjectURL(url);
    toast('Scenarios JSON exported.');
  });

  // ======= Toast =======
  let toastTimer=null; const toastDiv=document.createElement('div');
  toastDiv.style.position='fixed'; toastDiv.style.bottom='16px'; toastDiv.style.left='50%'; toastDiv.style.transform='translateX(-50%)';
  toastDiv.style.background='#111827'; toastDiv.style.color='#fff'; toastDiv.style.padding='10px 14px';
  toastDiv.style.borderRadius='10px'; toastDiv.style.boxShadow='0 6px 20px rgba(0,0,0,.15)'; toastDiv.style.zIndex='9999'; toastDiv.style.display='none';
  document.body.appendChild(toastDiv);
  function toast(msg){ clearTimeout(toastTimer); toastDiv.textContent=msg; toastDiv.style.display='block'; toastTimer=setTimeout(()=>toastDiv.style.display='none',1900); }

  // ======= Events =======
  $('#btnRandom').addEventListener('click', randomize);
  $('#btnLock').addEventListener('click', toggleLock);
  $('#btnNew').addEventListener('click', ()=>{ if(confirm('Clear current note?')){ clearAllFields(); autosave(); }});
  $('#btnSave').addEventListener('click', ()=>autosave());
  $('#btnLoad').addEventListener('click', ()=>{ if(!current){ toast('Select and lock a scenario first.'); return;} loadDraft(); });
  $('#btnExport').addEventListener('click', downloadWord);
  $('#btnCopy').addEventListener('click', copyPlain);
  $('#btnCopyScenario').addEventListener('click', copyScenario);
  $('#btnPrint').addEventListener('click', ()=>printPage());
  [F.context,F.design,F.purpose,F.outcomes,F.measures,F.designPlan,F.ethics,F.assumptions].forEach(el=>el.addEventListener('input', ()=>{ updateCounters(); autosave(); }));

  // Keyboard shortcuts
  window.addEventListener('keydown',(e)=>{
    if(['INPUT','TEXTAREA'].includes(document.activeElement.tagName) && (e.ctrlKey||e.metaKey)) return;
    if(e.key==='r'||e.key==='R'){ e.preventDefault(); randomize(); }
    if(e.key==='l'||e.key==='L'){ e.preventDefault(); toggleLock(); }
    if(e.key==='p'||e.key==='P'){ e.preventDefault(); printPage(); }
    if((e.key==='e'||e.key==='E') && locked){ e.preventDefault(); downloadWord(); }
  });

  // ======= Init =======
  function updateCounters(){ /* redefined for hoist-safe */ 
    $('#cntContext').textContent = `${wordCount($('#fContext').value)} words`;
    $('#cntDesign').textContent = `${wordCount($('#fDesign').value)} words`;
    $('#cntPurpose').textContent = `${wordCount($('#fPurpose').value)} words`;
    $('#cntOutcomes').textContent = `${wordCount($('#fOutcomes').value)} words`;
    $('#cntMeasures').textContent = `${wordCount($('#fMeasures').value)} words`;
    $('#cntDesignPlan').textContent = `${wordCount($('#fDesignPlan').value)} words`;
    $('#cntEthics').textContent = `${wordCount($('#fEthics').value)} words`;
    const hits=[$('#fContext'),$('#fDesign'),$('#fPurpose'),$('#fOutcomes'),$('#fMeasures'),$('#fDesignPlan'),$('#fEthics')].filter(x=>wordCount(x.value)>=100).length;
    $('#progress').textContent = `${hits}/7 sections with 100+ words`;
  }
  applyShowIds(); updateLockUi(); renderCase();
</script>
</body>
</html>
